@using Lab.PSO
@using MudBlazor

<MudCard>
    <MudCardHeader>
        <MudCardHeaderContent>
            <MudText Typo="Typo.h6">Тепловая карта использования ресурсов</MudText>
            <MudText Typo="Typo.body2">Визуализация утилизации памяти и вычислительных ресурсов</MudText>
        </MudCardHeaderContent>
    </MudCardHeader>
    
    <MudCardContent>
        @if (_data?.ResourceHeatmap?.MachineIds?.Count > 0)
        {
            <MudGrid>
                @for (int i = 0; i < _data.ResourceHeatmap.MachineIds.Count; i++)
                {
                    var machineId = _data.ResourceHeatmap.MachineIds[i];
                    var utilization = _data.ResourceHeatmap.UtilizationValues[i];
                    var backgroundColor = GetHeatmapColor(utilization);
                    var styleValue = $"background-color: {backgroundColor}; color: white;";
                    
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudPaper Class="pa-3 text-center" 
                                 Elevation="2" 
                                 Style="@styleValue">
                            <MudText Typo="Typo.h6">VM @machineId</MudText>
                            <MudText Typo="Typo.body2">@(utilization.ToString("P0"))</MudText>
                            <MudLinearProgress Color="@GetUtilizationColor(utilization)"
                                             Value="@(utilization * 100)"
                                             Class="mt-2" />
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
            
            <!-- Статистика -->
            <MudGrid Class="mt-3">
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-2 text-center" Elevation="1">
                        <MudText Typo="Typo.caption" Color="Color.Default">Минимум</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Success">
                            @(_minUtilization.ToString("P0"))
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-2 text-center" Elevation="1">
                        <MudText Typo="Typo.caption" Color="Color.Default">Среднее</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            @(_avgUtilization.ToString("P0"))
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-2 text-center" Elevation="1">
                        <MudText Typo="Typo.caption" Color="Color.Default">Максимум</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Error">
                            @(_maxUtilization.ToString("P0"))
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-2 text-center" Elevation="1">
                        <MudText Typo="Typo.caption" Color="Color.Default">Неравномерность</MudText>
                        <MudText Typo="Typo.h6" Color="@GetImbalanceColor(_imbalance)">
                            @(_imbalance.ToString("P1"))
                        </MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            
            <!-- Легенда -->
            <div style="display: flex; align-items: center; justify-content: center; margin-top: 16px;">
                <MudText Typo="Typo.caption" Class="mr-2">0%</MudText>
                <div style="width: 200px; height: 20px; border-radius: 4px; background: linear-gradient(to right, #4CAF50, #FFC107, #F44336);"></div>
                <MudText Typo="Typo.caption" Class="ml-2">100%</MudText>
            </div>
        }
        else
        {
            <MudText Class="text-center my-8" Typo="Typo.body1" Color="Color.Default">
                Нет данных для отображения тепловой карты.
            </MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public VisualizationData? Data { get; set; }
    
    private VisualizationData? _data;
    private double _minUtilization;
    private double _maxUtilization;
    private double _avgUtilization;
    private double _imbalance;
    
    protected override void OnParametersSet()
    {
        if (Data != _data)
        {
            _data = Data;
            UpdateStatistics();
        }
    }
    
    private void UpdateStatistics()
    {
        if (_data?.ResourceHeatmap?.UtilizationValues?.Count > 0)
        {
            var values = _data.ResourceHeatmap.UtilizationValues;
            _minUtilization = values.Min();
            _maxUtilization = values.Max();
            _avgUtilization = values.Average();
            
            // Рассчитываем неравномерность (стандартное отклонение)
            var variance = values.Sum(v => Math.Pow(v - _avgUtilization, 2)) / values.Count;
            _imbalance = Math.Sqrt(variance);
        }
        else
        {
            _minUtilization = _maxUtilization = _avgUtilization = _imbalance = 0;
        }
    }
    
    private string GetHeatmapColor(double value)
    {
        // Градиент от зеленого к красному
        if (value <= 0.5)
        {
            // Зеленый -> Желтый
            var ratio = value * 2;
            var r = (int)(255 * ratio);
            var g = 255;
            var b = 0;
            return $"rgb({r}, {g}, {b})";
        }
        else
        {
            // Желтый -> Красный
            var ratio = (value - 0.5) * 2;
            var r = 255;
            var g = (int)(255 * (1 - ratio));
            var b = 0;
            return $"rgb({r}, {g}, {b})";
        }
    }
    
    private Color GetUtilizationColor(double utilization)
    {
        return utilization switch
        {
            > 0.9 => Color.Error,
            > 0.7 => Color.Warning,
            _ => Color.Success
        };
    }
    
    private Color GetImbalanceColor(double imbalance)
    {
        return imbalance switch
        {
            > 0.3 => Color.Error,
            > 0.15 => Color.Warning,
            _ => Color.Success
        };
    }
}