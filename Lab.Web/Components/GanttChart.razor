@using Lab.PSO
@using MudBlazor

<MudCard>
    <MudCardHeader>
        <MudCardHeaderContent>
            <MudText Typo="Typo.h6">Диаграмма Ганта - Расписание выполнения</MudText>
            <MudText Typo="Typo.body2">Визуализация расписания задач на виртуальных машинах</MudText>
        </MudCardHeaderContent>
    </MudCardHeader>
    
    <MudCardContent>
        @if (_data?.GanttChart?.TaskIds?.Count > 0)
        {
            <MudText Typo="Typo.body2" Class="mb-3">
                Всего задач: @_data.GanttChart.TaskIds.Count
                | Максимальное время: @_data.Summary?.Makespan.ToString("F2")
            </MudText>
            
            <!-- Упрощенный вид: таблица с задачами -->
            <MudTable Items="@_ganttTasks" Hover="true" Striped="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>Задача</MudTh>
                    <MudTh>Машина</MudTh>
                    <MudTh>Начало</MudTh>
                    <MudTh>Завершение</MudTh>
                    <MudTh>Длительность</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @{
                        var task = (GanttTaskInfo)context;
                    }
                    <MudTr>
                        <MudTd>T@(task.TaskId)</MudTd>
                        <MudTd>
                            <MudChip T="string" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small">
                                VM @task.MachineId
                            </MudChip>
                        </MudTd>
                        <MudTd>@task.StartTime.ToString("F2")</MudTd>
                        <MudTd>@task.CompletionTime.ToString("F2")</MudTd>
                        <MudTd>@task.Duration.ToString("F2")</MudTd>
                    </MudTr>
                </RowTemplate>
            </MudTable>
            
            <!-- Визуализация временной шкалы -->
            <div style="margin-top: 20px; overflow-x: auto;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    @foreach (var machineGroup in _machineGroups)
                    {
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="min-width: 80px;">
                                <MudChip T="string" Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small">
                                    VM @machineGroup.Key
                                </MudChip>
                            </div>
                            <div style="flex: 1; height: 30px; position: relative; background-color: #f5f5f5; border-radius: 4px;">
                                @foreach (var task in machineGroup)
                                {
                                    var left = (task.StartTime / _maxTime) * 100;
                                    var width = (task.Duration / _maxTime) * 100;
                                    
                                    <div style="position: absolute;
                                                left: @(left)%;
                                                width: @(width)%;
                                                height: 24px;
                                                background-color: @GetTaskColor(task.TaskId);
                                                border-radius: 3px;
                                                margin: 3px 0;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                cursor: pointer;"
                                         @onmouseover="() => ShowTaskTooltip(task)"
                                         @onmouseout="HideTaskTooltip">
                                        <span style="font-size: 10px; font-weight: bold; color: white;">T@(task.TaskId)</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                
                <!-- Временная шкала -->
                <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 80px;">
                    @for (int i = 0; i <= 5; i++)
                    {
                        var time = (i * _maxTime) / 5;
                        <div style="text-align: center; font-size: 12px; color: #666;">
                            @time.ToString("F1")
                        </div>
                    }
                </div>
            </div>
            
            @if (_selectedTask != null)
            {
                <MudPaper Class="pa-3 mt-3" Elevation="5" style="background-color: white; border-left: 4px solid #2196F3;">
                    <MudText Typo="Typo.subtitle2">Задача @_selectedTask.TaskId</MudText>
                    <MudGrid>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">
                                <strong>Начало:</strong> @_selectedTask.StartTime.ToString("F2")
                            </MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">
                                <strong>Завершение:</strong> @_selectedTask.CompletionTime.ToString("F2")
                            </MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">
                                <strong>Длительность:</strong> @_selectedTask.Duration.ToString("F2")
                            </MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">
                                <strong>Машина:</strong> @_selectedTask.MachineId
                            </MudText>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            }
        }
        else
        {
            <MudText Class="text-center my-8" Typo="Typo.body1" Color="Color.Default">
                Нет данных для отображения. Запустите алгоритм для получения расписания.
            </MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public VisualizationData? Data { get; set; }
    
    private VisualizationData? _data;
    private List<GanttTaskInfo> _ganttTasks = new();
    private List<IGrouping<int, GanttTaskInfo>> _machineGroups = new();
    private double _maxTime = 100;
    private GanttTaskInfo? _selectedTask;
    
    protected override void OnParametersSet()
    {
        if (Data != _data)
        {
            _data = Data;
            UpdateGanttData();
        }
    }
    
    private void UpdateGanttData()
    {
        _ganttTasks.Clear();
        
        if (_data?.GanttChart == null)
            return;
            
        // Создаем список задач
        for (int i = 0; i < _data.GanttChart.TaskIds.Count; i++)
        {
            var task = new GanttTaskInfo
            {
                TaskId = _data.GanttChart.TaskIds[i],
                StartTime = _data.GanttChart.StartTimes[i],
                Duration = _data.GanttChart.Durations[i],
                MachineId = _data.GanttChart.MachineIds[i],
                CompletionTime = _data.GanttChart.StartTimes[i] + _data.GanttChart.Durations[i]
            };
            _ganttTasks.Add(task);
        }
        
        // Группируем по машинам
        _machineGroups = _ganttTasks
            .Where(t => t.MachineId > 0)
            .GroupBy(t => t.MachineId)
            .ToList();
            
        // Находим максимальное время
        if (_ganttTasks.Any())
        {
            _maxTime = _ganttTasks.Max(t => t.CompletionTime);
            _maxTime = Math.Max(_maxTime, 1); // Чтобы избежать деления на ноль
        }
    }
    
    private string GetTaskColor(int taskId)
    {
        var hue = (taskId * 137) % 360;
        return $"hsl({hue}, 70%, 60%)";
    }
    
    private void ShowTaskTooltip(GanttTaskInfo task)
    {
        _selectedTask = task;
        StateHasChanged();
    }
    
    private void HideTaskTooltip()
    {
        _selectedTask = null;
        StateHasChanged();
    }
    
    private class GanttTaskInfo
    {
        public int TaskId { get; set; }
        public double StartTime { get; set; }
        public double Duration { get; set; }
        public int MachineId { get; set; }
        public double CompletionTime { get; set; }
    }
}