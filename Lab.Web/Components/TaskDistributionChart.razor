@using Lab.PSO
@using MudBlazor

<MudCard>
    <MudCardHeader>
        <MudCardHeaderContent>
            <MudText Typo="Typo.h6">Распределение задач по машинам</MudText>
            <MudText Typo="Typo.body2">Визуализация нагрузки на виртуальные машины</MudText>
        </MudCardHeaderContent>
    </MudCardHeader>
    
    <MudCardContent>
        @if (_data?.DistributionChart?.MachineIds?.Count > 0)
        {
            <div style="border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;">
                <div style="background-color: #f5f5f5; padding: 12px 16px; border-bottom: 1px solid #e0e0e0;">
                    <MudGrid>
                        <MudItem xs="4">
                            <MudText Typo="Typo.caption" Class="text-center">Машина</MudText>
                        </MudItem>
                        <MudItem xs="4">
                            <MudText Typo="Typo.caption" Class="text-center">Количество задач</MudText>
                        </MudItem>
                        <MudItem xs="4">
                            <MudText Typo="Typo.caption" Class="text-center">Загрузка</MudText>
                        </MudItem>
                    </MudGrid>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto;">
                    @for (int i = 0; i < _data.DistributionChart.MachineIds.Count; i++)
                    {
                        var machineId = _data.DistributionChart.MachineIds[i];
                        var taskCount = _data.DistributionChart.TaskCounts[i];
                        var utilization = GetMachineUtilization(machineId);
                        
                        <div @onclick="() => SelectMachine(machineId)" 
                             style="border-bottom: 1px solid #eee; transition: background-color 0.2s; cursor: pointer;">
                            <MudGrid Class="py-2">
                                <MudItem xs="4">
                                    <div style="display: flex; align-items: center;">
                                        <MudAvatar Color="Color.Primary" Size="Size.Small">
                                            @machineId
                                        </MudAvatar>
                                        <MudText Typo="Typo.body2" Class="ml-2">
                                            VM @machineId
                                        </MudText>
                                    </div>
                                </MudItem>
                                <MudItem xs="4">
                                    <div style="display: flex; align-items: center;">
                                        <MudProgressLinear 
                                            Color="GetTaskCountColor(taskCount)"
                                            Value="@(taskCount * 100 / _maxTaskCount)"
                                            Style="flex: 1; max-width: 100px;" />
                                        <MudText Typo="Typo.body2" Class="ml-2">
                                            @taskCount задач
                                        </MudText>
                                    </div>
                                </MudItem>
                                <MudItem xs="4">
                                    <div style="display: flex; align-items: center;">
                                        <MudProgressCircular 
                                            Color="GetUtilizationColor(utilization)"
                                            Value="@(utilization * 100)"
                                            Size="Size.Small" />
                                        <MudText Typo="Typo.body2" Class="ml-2">
                                            @(utilization.ToString("P0"))
                                        </MudText>
                                    </div>
                                </MudItem>
                            </MudGrid>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Сводная статистика -->
            <MudPaper Class="pa-3 mt-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.body2">
                            <strong>Всего машин:</strong> @_data.DistributionChart.MachineIds.Count
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.body2">
                            <strong>Всего задач:</strong> @_data.DistributionChart.TaskCounts.Sum()
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.body2">
                            <strong>Средняя загрузка:</strong> @(GetAverageUtilization().ToString("P0"))
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.body2">
                            <strong>Баланс:</strong> @(GetBalanceScore().ToString("F1"))%
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            
            <!-- График распределения -->
            <div style="height: 200px; position: relative; margin-top: 16px;">
                <canvas id="distributionChart" 
                        width="400" 
                        height="200"
                        @ref="_chartRef"></canvas>
            </div>
        }
        else
        {
            <MudText Class="text-center my-8" Typo="Typo.body1" Color="Color.Default">
                Нет данных для отображения распределения задач.
            </MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public VisualizationData? Data { get; set; }
    [Parameter] public EventCallback<int> OnMachineSelected { get; set; }
    
    private VisualizationData? _data;
    private ElementReference _chartRef;
    private int _maxTaskCount = 1;
    
    protected override async System.Threading.Tasks.Task OnParametersSetAsync()
    {
        if (Data != _data)
        {
            _data = Data;
            if (_data?.DistributionChart?.TaskCounts?.Count > 0)
            {
                _maxTaskCount = Math.Max(_data.DistributionChart.TaskCounts.Max(), 1);
                await RenderChart();
            }
        }
    }
    
    private async System.Threading.Tasks.Task RenderChart()
    {
        if (_data?.DistributionChart == null)
            return;
            
        // Здесь будет вызов JavaScript для отрисовки диаграммы
        await System.Threading.Tasks.Task.Delay(1); // Заглушка
    }
    
    private double GetMachineUtilization(int machineId)
    {
        if (_data?.ResourceHeatmap?.MachineIds == null)
            return 0;
            
        var index = _data.ResourceHeatmap.MachineIds.IndexOf(machineId);
        if (index >= 0 && index < _data.ResourceHeatmap.UtilizationValues.Count)
        {
            return _data.ResourceHeatmap.UtilizationValues[index];
        }
        
        return 0;
    }
    
    private Color GetTaskCountColor(int taskCount)
    {
        var ratio = (double)taskCount / _maxTaskCount;
        return ratio switch
        {
            > 0.8 => Color.Error,
            > 0.6 => Color.Warning,
            _ => Color.Success
        };
    }
    
    private Color GetUtilizationColor(double utilization)
    {
        return utilization switch
        {
            > 0.9 => Color.Error,
            > 0.7 => Color.Warning,
            _ => Color.Success
        };
    }
    
    private double GetAverageUtilization()
    {
        if (_data?.ResourceHeatmap?.UtilizationValues?.Count > 0)
        {
            return _data.ResourceHeatmap.UtilizationValues.Average();
        }
        return 0;
    }
    
    private double GetBalanceScore()
    {
        if (_data?.DistributionChart?.TaskCounts?.Count < 2)
            return 100;
            
        var counts = _data.DistributionChart.TaskCounts;
        var avg = counts.Average();
        var variance = counts.Sum(c => Math.Pow(c - avg, 2)) / counts.Count;
        var stdDev = Math.Sqrt(variance);
        
        // Оценка баланса от 0 до 100
        var maxDeviation = Math.Sqrt(_maxTaskCount);
        var balance = 100 * (1 - stdDev / maxDeviation);
        
        return Math.Max(0, Math.Min(100, balance));
    }
    
    private async System.Threading.Tasks.Task SelectMachine(int machineId)
    {
        await OnMachineSelected.InvokeAsync(machineId);
    }
    
    
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;
}