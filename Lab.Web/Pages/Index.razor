@page "/"
@using Lab.Web.Services
@using Lab.Domain
@using System.Text
@using Size = MudBlazor.Size
@inject AlgorithmService AlgorithmService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Алгоритмы оптимизации - Распределение задач в облачной среде</PageTitle>

<!-- Основная структура 1/3 слева, 2/3 справа -->
<MudGrid>
    <!-- Левая колонка (1/3) -->
    <MudItem xs="12" md="4" class="pl-md-4 pr-md-2">
        <!-- Панель управления -->
        <MudPaper Class="pa-3 mb-3" Elevation="1">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Панель управления</MudText>
                </MudItem>
                
                <!-- Выбор алгоритма -->
                <MudItem xs="12" Class="mb-3">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Выбор алгоритма</MudText>
                    <MudRadioGroup T="AlgorithmType" @bind-Value="_selectedAlgorithmType" Class="d-flex flex-column">
                        <MudRadio Value="@AlgorithmType.Pso" Class="mb-1">PSO (Рой частиц)</MudRadio>
                        <MudRadio Value="@AlgorithmType.Genetic">Генетический алгоритм</MudRadio>
                    </MudRadioGroup>
                </MudItem>
                
                <!-- Предустановленные эксперименты -->
                <MudItem xs="12" Class="mb-3">
                    <MudExpansionPanel Text="Предустановленные эксперименты" Icon="@Icons.Material.Filled.Science">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudSelect T="ExperimentPreset" @bind-Value="_selectedExperiment" 
                                          Label="Выберите эксперимент" 
                                          HelperText="10 экспериментов для анализа PSO"
                                          Variant="Variant.Outlined"
                                          ToStringFunc="GetExperimentName">
                                    @foreach (var preset in _experimentPresets)
                                    {
                                        <MudSelectItem Value="preset">@GetExperimentName(preset)</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            
                            <MudItem xs="12" Class="mt-2">
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Info"
                                          StartIcon="@Icons.Material.Filled.Input"
                                          OnClick="LoadExperimentPreset"
                                          FullWidth="true"
                                          Size="Size.Small">
                                    Загрузить параметры эксперимента
                                </MudButton>
                            </MudItem>
                            
                            <MudItem xs="12" Class="mt-2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Всего 10 экспериментов. Каждый эксперимент нужно запустить 2 раза для статистики.
                                </MudText>
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudItem>
                
                <!-- Конфигурация задачи -->
                <MudItem xs="12" sm="6" md="6">
                    <MudNumericField T="int" @bind-Value="_config.TaskCount"
                                     Label="Количество задач"
                                     Min="1"
                                     Max="3000"
                                     Immediate="true"
                                     Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6" md="6">
                    <MudNumericField T="int" @bind-Value="_config.MachineCount"
                                     Label="Количество машин"
                                     Min="1"
                                     Max="600"
                                     Immediate="true"
                                     Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12">
                    <MudNumericField T="int?" @bind-Value="_config.RandomSeed"
                                     Label="Семя генератора"
                                     HelperText="Оставьте пустым для случайного"
                                     Margin="Margin.Dense" />
                </MudItem>
                
                <!-- Дополнительные параметры генерации -->
                <MudItem xs="12" Class="mt-3">
                    <MudExpansionPanel Text="Дополнительные параметры генерации" Icon="@Icons.Material.Filled.Tune">
                        <MudGrid>
                            <!-- Параметры задач -->
                            <MudItem xs="12">
                                <MudText Typo="Typo.subtitle2" Class="mb-2 mt-2">Параметры задач</MudText>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. объем вычислений: @_config.MinComputationVolume</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinComputationVolume"
                                          ValueChanged="@(v => _config.MinComputationVolume = v)"
                                          Min="1" 
                                          Max="50" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. объем вычислений: @_config.MaxComputationVolume</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxComputationVolume"
                                          ValueChanged="@(v => _config.MaxComputationVolume = v)"
                                          Min="50" 
                                          Max="200" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. требование памяти: @_config.MinMemoryRequirement</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinMemoryRequirement"
                                          ValueChanged="@(v => _config.MinMemoryRequirement = v)"
                                          Min="1" 
                                          Max="10" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. требование памяти: @_config.MaxMemoryRequirement</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxMemoryRequirement"
                                          ValueChanged="@(v => _config.MaxMemoryRequirement = v)"
                                          Min="10" 
                                          Max="50" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. предшественников: @_config.MaxPredecessors</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxPredecessors"
                                          ValueChanged="@(v => _config.MaxPredecessors = v)"
                                          Min="0" 
                                          Max="5" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <!-- Параметры машин -->
                            <MudItem xs="12" Class="mt-3">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Параметры машин</MudText>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. производительность: @_config.MinMachinePerformance</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinMachinePerformance"
                                          ValueChanged="@(v => _config.MinMachinePerformance = v)"
                                          Min="1" 
                                          Max="20" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. производительность: @_config.MaxMachinePerformance</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxMachinePerformance"
                                          ValueChanged="@(v => _config.MaxMachinePerformance = v)"
                                          Min="20" 
                                          Max="100" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. память машины: @_config.MinMachineMemory</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinMachineMemory"
                                          ValueChanged="@(v => _config.MinMachineMemory = v)"
                                          Min="5" 
                                          Max="20" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. память машины: @_config.MaxMachineMemory</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxMachineMemory"
                                          ValueChanged="@(v => _config.MaxMachineMemory = v)"
                                          Min="20" 
                                          Max="100" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <!-- Валидация -->
                            <MudItem xs="12" Class="mt-3">
                                @if (!_config.Validate())
                                {
                                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
                                        Ошибка валидации: Минимальные значения должны быть меньше максимальных
                                    </MudAlert>
                                }
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudItem>
                
                <!-- Настройки выбранного алгоритма -->
                <MudItem xs="12" Class="mt-3">
                    <MudText Typo="Typo.h6" Class="mb-2">
                        @(_selectedAlgorithmType == AlgorithmType.Pso ? "Настройки алгоритма PSO" : "Настройки генетического алгоритма")
                    </MudText>
                </MudItem>
                
                @if (_selectedAlgorithmType == AlgorithmType.Pso)
                {
                    <!-- Настройки PSO -->
                    <MudItem xs="12" sm="6" md="6">
                        <MudNumericField T="int" @bind-Value="_psoConfig.SwarmSize"
                                         Label="Размер роя"
                                         Min="10"
                                         Max="200"
                                         Immediate="true"
                                         Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudNumericField T="int" @bind-Value="_psoConfig.MaxIterations"
                                         Label="Макс. итераций"
                                         Min="10"
                                         Max="1000"
                                         Immediate="true"
                                         Margin="Margin.Dense" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2">Инерция (w): @_psoConfig.InertiaWeight.ToString("F1")</MudText>
                        <MudSlider T="double" 
                                  Value="@_psoConfig.InertiaWeight"
                                  ValueChanged="@(v => _psoConfig.InertiaWeight = v)"
                                  Min="0.1" 
                                  Max="1.5" 
                                  Step="0.1"
                                  Immediate="true"
                                  ValueLabel="true"
                                  Class="mt-1" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2">Когнитивный (c1): @_psoConfig.CognitiveWeight.ToString("F1")</MudText>
                        <MudSlider T="double" 
                                  Value="@_psoConfig.CognitiveWeight"
                                  ValueChanged="@(v => _psoConfig.CognitiveWeight = v)"
                                  Min="0.1" 
                                  Max="3.0" 
                                  Step="0.1"
                                  Immediate="true"
                                  ValueLabel="true"
                                  Class="mt-1" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2">Социальный (c2): @_psoConfig.SocialWeight.ToString("F1")</MudText>
                        <MudSlider T="double" 
                                  Value="@_psoConfig.SocialWeight"
                                  ValueChanged="@(v => _psoConfig.SocialWeight = v)"
                                  Min="0.1" 
                                  Max="3.0" 
                                  Step="0.1"
                                  Immediate="true"
                                  ValueLabel="true"
                                  Class="mt-1" />
                    </MudItem>
                    
                    <MudItem xs="12" Class="mt-2">
                        <MudNumericField T="int" @bind-Value="_psoConfig.NoImprovementLimit"
                                         Label="Лимит без улучшений"
                                         Min="5"
                                         Max="200"
                                         HelperText="Остановка после N итераций без улучшений"
                                         Immediate="true"
                                         Margin="Margin.Dense" />
                    </MudItem>
                }
                else
                {
                    <!-- Настройки генетического алгоритма -->
                    <MudItem xs="12" sm="6" md="6">
                        <MudNumericField T="int" @bind-Value="_gaConfig.PopulationSize"
                                         Label="Размер популяции"
                                         Min="10"
                                         Max="500"
                                         Immediate="true"
                                         Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudNumericField T="int" @bind-Value="_gaConfig.MaxGenerations"
                                         Label="Макс. поколений"
                                         Min="10"
                                         Max="1000"
                                         Immediate="true"
                                         Margin="Margin.Dense" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2">Вероятность кроссовера: @_gaConfig.CrossoverRate.ToString("P0")</MudText>
                        <MudSlider T="double" 
                                  Value="@_gaConfig.CrossoverRate"
                                  ValueChanged="@(v => _gaConfig.CrossoverRate = v)"
                                  Min="0.1" 
                                  Max="1.0" 
                                  Step="0.05"
                                  Immediate="true"
                                  ValueLabel="true"
                                  Class="mt-1" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2">Вероятность мутации: @_gaConfig.MutationRate.ToString("P0")</MudText>
                        <MudSlider T="double" 
                                  Value="@_gaConfig.MutationRate"
                                  ValueChanged="@(v => _gaConfig.MutationRate = v)"
                                  Min="0.01" 
                                  Max="0.5" 
                                  Step="0.01"
                                  Immediate="true"
                                  ValueLabel="true"
                                  Class="mt-1" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2">Доля элитных особей: @_gaConfig.EliteRatio.ToString("P0")</MudText>
                        <MudSlider T="double" 
                                  Value="@_gaConfig.EliteRatio"
                                  ValueChanged="@(v => _gaConfig.EliteRatio = v)"
                                  Min="0.05" 
                                  Max="0.3" 
                                  Step="0.05"
                                  Immediate="true"
                                  ValueLabel="true"
                                  Class="mt-1" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2">Размер турнира: @_gaConfig.TournamentSize</MudText>
                        <MudSlider T="int" 
                                  Value="@_gaConfig.TournamentSize"
                                  ValueChanged="@(v => _gaConfig.TournamentSize = v)"
                                  Min="2" 
                                  Max="10" 
                                  Step="1"
                                  Immediate="true"
                                  ValueLabel="true"
                                  Class="mt-1" />
                    </MudItem>
                    
                    <MudItem xs="12" Class="mt-2">
                        <MudNumericField T="int" @bind-Value="_gaConfig.NoImprovementLimit"
                                         Label="Лимит без улучшений"
                                         Min="5"
                                         Max="200"
                                         HelperText="Остановка после N поколений без улучшений"
                                         Immediate="true"
                                         Margin="Margin.Dense" />
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>

        <!-- Кнопки управления -->
        <MudPaper Class="pa-3 mb-3" Elevation="1">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Управление выполнением</MudText>
                </MudItem>
                
                <!-- Статус -->
                <MudItem xs="12" Class="mb-2">
                    <div class="d-flex justify-center">
                        <MudChip T="string" Variant="Variant.Filled" 
                                 Color="GetStatusColor(AlgorithmService.Status)"
                                 Class="ma-1">
                            @GetStatusText(AlgorithmService.Status)
                        </MudChip>
                        <MudChip T="string" Variant="Variant.Outlined" 
                                 Color="Color.Primary"
                                 Class="ma-1">
                            @(_selectedAlgorithmType == AlgorithmType.Pso ? "PSO" : "Генетический")
                        </MudChip>
                    </div>
                </MudItem>

                <!-- Кнопка инициализации -->
                <MudItem xs="12" Class="mb-2">
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.PlayArrow"
                              OnClick="@InitializeProblem"
                              FullWidth="true"
                              Disabled="@(AlgorithmService.Status == AlgorithmStatus.Running || !_config.Validate())"
                              Size="Size.Small">
                        Инициализировать задачу
                    </MudButton>
                </MudItem>
                
                <!-- Пошаговый режим -->
                <MudItem xs="12" Class="mb-2">
                    <MudCheckBox T="bool"
                                 @bind-Value="_stepMode"
                                 Disabled="@(AlgorithmService.Status == AlgorithmStatus.Running)"
                                 Label="Пошаговый режим"
                                 Size="Size.Small" />
                </MudItem>
                
                <!-- Кнопки управления -->
                <MudItem xs="12" Class="mt-2">
                    <div class="d-flex flex-column gap-2">
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Success"
                                  StartIcon="@Icons.Material.Filled.PlayCircle"
                                  OnClick="@StartAlgorithm"
                                  Disabled="@(AlgorithmService.Status != AlgorithmStatus.Ready && AlgorithmService.Status != AlgorithmStatus.Completed || !_config.Validate())"
                                  Loading="@_isRunning"
                                  Size="Size.Small">
                            @(_isRunning ? "Выполняется..." : "Запустить алгоритм")
                        </MudButton>

                        @if (_stepMode)
                        {
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.SkipNext"
                                      OnClick="@StepAlgorithm"
                                      Disabled="!AlgorithmService.CanStep"
                                      Size="Size.Small">
                                Шаг
                            </MudButton>
                        }
                        
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Error"
                                  StartIcon="@Icons.Material.Filled.Stop"
                                  OnClick="@StopAlgorithm"
                                  Disabled="@(AlgorithmService.Status != AlgorithmStatus.Running)"
                                  Size="Size.Small">
                            Остановить
                        </MudButton>
                        
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Secondary"
                                  StartIcon="@Icons.Material.Filled.Refresh"
                                  OnClick="@ResetAlgorithm"
                                  Size="Size.Small">
                            Сброс
                        </MudButton>
                    </div>
                </MudItem>

                <!-- Экспорт результатов -->
                <MudItem xs="12" Class="mt-3">
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Info"
                              StartIcon="@Icons.Material.Filled.Download"
                              OnClick="ExportResults"
                              FullWidth="true"
                              Disabled="@(AlgorithmService.CurrentSolution == null)"
                              Size="Size.Small">
                        Экспорт результатов
                    </MudButton>
                </MudItem>

                <!-- Запуск серии экспериментов -->
                <MudItem xs="12" Class="mt-3">
                    <MudExpansionPanel Text="Серия экспериментов" Icon="@Icons.Material.Filled.AutoAwesome">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    Запуск 10 экспериментов (основной алгоритм - PSO). 
                                    Каждый эксперимент будет запущен 2 раза для статистики.
                                </MudText>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Warning"
                                          StartIcon="@Icons.Material.Filled.PlaylistPlay"
                                          OnClick="RunExperimentSeries"
                                          FullWidth="true"
                                          Disabled="@(AlgorithmService.Status == AlgorithmStatus.Running)"
                                          Size="Size.Small">
                                    Запустить серию экспериментов
                                </MudButton>
                            </MudItem>
                            
                            <MudItem xs="12" Class="mt-2">
                                <MudCheckBox T="bool"
                                             @bind-Value="_includeGaComparison"
                                             Label="Включить сравнение с GA"
                                             Size="Size.Small" />
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Информация о задаче -->
        @if (AlgorithmService.CurrentInstance != null)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Информация о задаче</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E3F2FD;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Задач</MudText>
                            <MudText Typo="Typo.h5">@AlgorithmService.CurrentInstance.Tasks.Count</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E8F5E9;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Машин</MudText>
                            <MudText Typo="Typo.h5">@AlgorithmService.CurrentInstance.VirtualMachines.Count</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #FFF3E0;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Зависимостей</MudText>
                            <MudText Typo="Typo.h5">
                                @AlgorithmService.CurrentInstance.Tasks.Values.Sum(t => t.PredecessorIds.Count)
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #F3E5F5;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Общая память</MudText>
                            <MudText Typo="Typo.h5">
                                @AlgorithmService.CurrentInstance.VirtualMachines.Values.Sum(m => m.AvailableMemory)
                            </MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        <!-- Результаты -->
        @if (AlgorithmService.CurrentSolution != null)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Результаты решения</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Алгоритм: @(_selectedAlgorithmType == AlgorithmType.Pso ? "PSO" : "Генетический")
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E8F5E9;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Makespan</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">
                                @AlgorithmService.CurrentSolution.Makespan.ToString("F2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #FFF3E0;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Штраф</MudText>
                            <MudText Typo="Typo.h5" Color="@GetPenaltyColor(AlgorithmService.CurrentSolution.TotalPenalty)">
                                @AlgorithmService.CurrentSolution.TotalPenalty.ToString("F2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E3F2FD;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Фитнес</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Primary">
                                @AlgorithmService.CurrentSolution.Fitness.ToString("F2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #F3E5F5;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Время вычисления</MudText>
                            <MudText Typo="Typo.h5">
                                @AlgorithmService.CurrentSolution.ComputationTime.TotalSeconds.ToString("F2") с
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" Class="mt-2">
                        <MudAlert Severity="GetFeasibilitySeverity(AlgorithmService.CurrentSolution.TotalPenalty)"
                                  Variant="Variant.Filled"
                                  Dense="true"
                                  Size="Size.Small">
                            @GetFeasibilityMessage(AlgorithmService.CurrentSolution.TotalPenalty)
                        </MudAlert>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        <!-- История экспериментов -->
        @if (_experimentHistory.Count > 0)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">История экспериментов</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Выполнено: @_experimentHistory.Count экспериментов
                        </MudText>
                    </MudItem>
                    
                    <MudItem xs="12" Class="mt-2">
                        <MudTable Items="@_experimentHistory" Hover="true" Dense="true" Class="elevation-1">
                            <HeaderContent>
                                <MudTh>№</MudTh>
                                <MudTh>Алгоритм</MudTh>
                                <MudTh>Makespan</MudTh>
                                <MudTh>Время (с)</MudTh>
                                <MudTh>Действия</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@(context.ExperimentNumber)</MudTd>
                                <MudTd>@context.AlgorithmType</MudTd>
                                <MudTd>@context.Makespan.ToString("F2")</MudTd>
                                <MudTd>@context.ComputationTime.TotalSeconds.ToString("F2")</MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                   Size="Size.Small"
                                                   OnClick="() => LoadExperimentResult(context)" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudItem>
                    
                    <MudItem xs="12" Class="mt-3">
                        <MudButton Variant="Variant.Outlined"
                                  Color="Color.Info"
                                  StartIcon="@Icons.Material.Filled.Download"
                                  OnClick="ExportExperimentHistory"
                                  FullWidth="true"
                                  Size="Size.Small">
                            Экспорт истории экспериментов
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
    </MudItem>

    <!-- Правая колонка (2/3) -->
    <MudItem xs="12" md="8" class="pr-md-4 pl-md-2">
        <!-- Управление видимостью -->
        <MudPaper Class="pa-3 mb-3" Elevation="1">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Управление визуализацией</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSwitch @bind-Value="_showGraph"
                               Color="Color.Primary"
                               Label="Показать граф назначений"
                               Disabled="@(AlgorithmService.CurrentInstance == null)"
                               Size="Size.Small" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSwitch @bind-Value="_showHeatmap"
                               Color="Color.Primary"
                               Label="Показать тепловую карту"
                               Disabled="@(AlgorithmService.CurrentSolution == null)"
                               Size="Size.Small" />
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Граф назначений -->
        @if (_showGraph && AlgorithmService.CurrentInstance != null)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <BipartiteGraphView Instance="AlgorithmService.CurrentInstance" 
                                   Solution="AlgorithmService.CurrentSolution" />
            </MudPaper>
        }

        <!-- Тепловая карта -->
        @if (_showHeatmap && AlgorithmService.VisualizationData != null && AlgorithmService.VisualizationData.ResourceHeatmap?.MachineIds?.Count > 0)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Тепловая карта утилизации ресурсов</MudText>
                        <MudText Typo="Typo.body2" Class="mb-2">
                            Визуализация использования вычислительных ресурсов виртуальных машин
                        </MudText>
                    </MudItem>
                    
                    <!-- Статистика -->
                    <MudItem xs="12" Class="mb-2">
                        @{
                            var heatmapData = AlgorithmService.VisualizationData.ResourceHeatmap;
                            var minUtil = heatmapData.UtilizationValues.Min();
                            var maxUtil = heatmapData.UtilizationValues.Max();
                            var avgUtil = heatmapData.UtilizationValues.Average();
                            var variance = heatmapData.UtilizationValues.Sum(v => Math.Pow(v - avgUtil, 2)) / heatmapData.UtilizationValues.Count;
                            var imbalance = Math.Sqrt(variance);
                        }
                        <MudGrid>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Минимум</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success">
                                        @(minUtil.ToString("P0"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Среднее</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Primary">
                                        @(avgUtil.ToString("P0"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Максимум</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Error">
                                        @(maxUtil.ToString("P0"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Неравномерность</MudText>
                                    <MudText Typo="Typo.h6" Color="@GetImbalanceColor(imbalance)">
                                        @(imbalance.ToString("P1"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </MudItem>

                    <!-- Тепловая карта MudBlazor -->
                    <MudItem xs="12" Class="mt-3">
                        <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background-color: #fafafa;">
                            <MudChart ChartType="ChartType.HeatMap" 
                                     ChartSeries="@_heatmapSeries" 
                                     ChartOptions="@_heatmapOptions"
                                     XAxisLabels="@_xLabels" 
                                     YAxisLabels="@_yLabels"
                                     Width="100%" 
                                     Height="400px"
                                     Style="--mud-palette-heatmap-cell-min-width: 72px; --mud-palette-heatmap-cell-font-size: 0.76rem; --mud-palette-heatmap-cell-font-weight: 500;"
                                     TooltipEnabled="true"></MudChart>
                            
                            <!-- Панель управления градиентом -->
                            <div class="mt-3" style="display: flex; align-items: center; justify-content: space-between; padding: 0 10px;">
                                <div style="display: flex; align-items: center;">
                                    <MudCheckBox T="bool" @bind-Value="_enableSmoothGradient" 
                                               @bind-Value:after="BuildOptions" 
                                               Color="Color.Primary"
                                               Label="Плавный градиент"
                                               Size="Size.Small">
                                    </MudCheckBox>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 10px; flex: 1; justify-content: center;">
                                    <MudText Typo="Typo.caption" Color="Color.Default" Style="min-width: 30px;">0%</MudText>
                                    <div style="flex: 1; max-width: 400px; height: 20px; border-radius: 4px; background: linear-gradient(to right, #5AC8FA, #34C759, #007AFF);"></div>
                                    <MudText Typo="Typo.caption" Color="Color.Default" Style="min-width: 40px;">100%</MudText>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Palette" Size="Size.Small" Color="Color.Primary" />
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        Градиент: @(_enableSmoothGradient ? "Плавный" : "Дискретный")
                                    </MudText>
                                </div>
                            </div>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else if (_showHeatmap)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Тепловая карта утилизации ресурсов</MudText>
                        <MudText Typo="Typo.body2" Class="mb-2">
                            Визуализация использования вычислительных ресурсов виртуальных машин
                        </MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <div style="text-align: center; padding: 30px; border: 2px dashed #e0e0e0; border-radius: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.ShowChart" Size="Size.Large" Color="Color.Default" Class="mb-2" />
                            <MudText Typo="Typo.body1" Color="Color.Default" Class="d-block mb-2">
                                Нет данных для отображения тепловой карты
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Default" Class="d-block">
                                Запустите алгоритм для получения результатов распределения задач
                            </MudText>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
    </MudItem>
</MudGrid>

@code {
    // Конфигурация
    private AlgorithmType _selectedAlgorithmType = AlgorithmType.Pso;
    private ProblemConfiguration _config = new() { 
        TaskCount = 20, 
        MachineCount = 4,
        MinComputationVolume = 10,
        MaxComputationVolume = 100,
        MinMemoryRequirement = 1,
        MaxMemoryRequirement = 20,
        MaxPredecessors = 3,
        MinMachinePerformance = 5,
        MaxMachinePerformance = 25,
        MinMachineMemory = 10,
        MaxMachineMemory = 30
    };
    private PsoConfiguration _psoConfig = PsoConfiguration.Default;
    private GaConfiguration _gaConfig = GaConfiguration.Default;
    
    // Состояние UI
    private bool _isRunning = false;
    private bool _stepMode = false;
    private bool _showGraph = true;
    private bool _showHeatmap = true;
    private bool _includeGaComparison = true;
    
    // Данные для тепловой карты
    private bool _enableSmoothGradient = true;
    private readonly string[] _colors = ["#5AC8FA", "#34C759", "#007AFF"];
    private List<ChartSeries> _heatmapSeries = [];
    private ChartOptions _heatmapOptions = new();
    private string[] _xLabels = []; // Метки по оси X (машины)
    private string[] _yLabels = []; // Метки по оси Y (метрики)
    
    // Эксперименты
    private List<ExperimentPreset> _experimentPresets = new();
    private ExperimentPreset? _selectedExperiment;
    private List<ExperimentResult> _experimentHistory = new();
    private int _experimentCounter = 1;
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        BuildOptions();
        InitializeExperimentPresets();
        
        // Подписываемся на события сервиса
        AlgorithmService.OnProgressChanged += HandleProgressChanged;
        AlgorithmService.OnSolutionFound += HandleSolutionFound;
        AlgorithmService.OnVisualizationDataUpdated += HandleVisualizationUpdated;
        AlgorithmService.OnStatusChanged += HandleStatusChanged;
    }
    
    private void InitializeExperimentPresets()
    {
        _experimentPresets = new List<ExperimentPreset>
        {
            // Эксперимент 1: Маленькая задача
            new ExperimentPreset
            {
                Id = 1,
                Name = "Эксперимент 1: Маленькая задача",
                TaskCount = 10,
                MachineCount = 2,
                RandomSeed = 12345,
                MinComputationVolume = 5,
                MaxComputationVolume = 50,
                MinMemoryRequirement = 1,
                MaxMemoryRequirement = 10,
                MaxPredecessors = 2,
                MinMachinePerformance = 5,
                MaxMachinePerformance = 15,
                MinMachineMemory = 10,
                MaxMachineMemory = 30,
                PsoSwarmSize = 20,
                PsoMaxIterations = 100,
                PsoInertiaWeight = 0.7,
                PsoCognitiveWeight = 1.5,
                PsoSocialWeight = 1.5,
                PsoNoImprovementLimit = 20,
                GaPopulationSize = 30,
                GaMaxGenerations = 100,
                GaCrossoverRate = 0.8,
                GaMutationRate = 0.1,
                GaEliteRatio = 0.1,
                GaTournamentSize = 3,
                GaNoImprovementLimit = 20
            },
            
            // Эксперимент 2: Средняя задача
            new ExperimentPreset
            {
                Id = 2,
                Name = "Эксперимент 2: Средняя задача",
                TaskCount = 50,
                MachineCount = 5,
                RandomSeed = 23456,
                MinComputationVolume = 10,
                MaxComputationVolume = 100,
                MinMemoryRequirement = 2,
                MaxMemoryRequirement = 20,
                MaxPredecessors = 3,
                MinMachinePerformance = 10,
                MaxMachinePerformance = 30,
                MinMachineMemory = 20,
                MaxMachineMemory = 50,
                PsoSwarmSize = 30,
                PsoMaxIterations = 200,
                PsoInertiaWeight = 0.8,
                PsoCognitiveWeight = 1.7,
                PsoSocialWeight = 1.7,
                PsoNoImprovementLimit = 30,
                GaPopulationSize = 50,
                GaMaxGenerations = 200,
                GaCrossoverRate = 0.85,
                GaMutationRate = 0.08,
                GaEliteRatio = 0.1,
                GaTournamentSize = 4,
                GaNoImprovementLimit = 30
            },
            
            // Эксперимент 3: Большая задача
            new ExperimentPreset
            {
                Id = 3,
                Name = "Эксперимент 3: Большая задача",
                TaskCount = 100,
                MachineCount = 10,
                RandomSeed = 34567,
                MinComputationVolume = 20,
                MaxComputationVolume = 150,
                MinMemoryRequirement = 5,
                MaxMemoryRequirement = 30,
                MaxPredecessors = 4,
                MinMachinePerformance = 15,
                MaxMachinePerformance = 50,
                MinMachineMemory = 30,
                MaxMachineMemory = 80,
                PsoSwarmSize = 50,
                PsoMaxIterations = 300,
                PsoInertiaWeight = 0.6,
                PsoCognitiveWeight = 2.0,
                PsoSocialWeight = 2.0,
                PsoNoImprovementLimit = 40,
                GaPopulationSize = 80,
                GaMaxGenerations = 300,
                GaCrossoverRate = 0.9,
                GaMutationRate = 0.05,
                GaEliteRatio = 0.15,
                GaTournamentSize = 5,
                GaNoImprovementLimit = 40
            },
            
            // Эксперимент 4: Много зависимостей
            new ExperimentPreset
            {
                Id = 4,
                Name = "Эксперимент 4: Много зависимостей",
                TaskCount = 60,
                MachineCount = 6,
                RandomSeed = 45678,
                MinComputationVolume = 15,
                MaxComputationVolume = 120,
                MinMemoryRequirement = 3,
                MaxMemoryRequirement = 25,
                MaxPredecessors = 5, // Много зависимостей
                MinMachinePerformance = 12,
                MaxMachinePerformance = 40,
                MinMachineMemory = 25,
                MaxMachineMemory = 60,
                PsoSwarmSize = 40,
                PsoMaxIterations = 250,
                PsoInertiaWeight = 0.65,
                PsoCognitiveWeight = 1.6,
                PsoSocialWeight = 1.6,
                PsoNoImprovementLimit = 35,
                GaPopulationSize = 60,
                GaMaxGenerations = 250,
                GaCrossoverRate = 0.75,
                GaMutationRate = 0.12,
                GaEliteRatio = 0.1,
                GaTournamentSize = 3,
                GaNoImprovementLimit = 35
            },
            
            // Эксперимент 5: Мало памяти
            new ExperimentPreset
            {
                Id = 5,
                Name = "Эксперимент 5: Мало памяти",
                TaskCount = 40,
                MachineCount = 4,
                RandomSeed = 56789,
                MinComputationVolume = 10,
                MaxComputationVolume = 80,
                MinMemoryRequirement = 8, // Большие требования памяти
                MaxMemoryRequirement = 25,
                MaxPredecessors = 3,
                MinMachinePerformance = 10,
                MaxMachinePerformance = 25,
                MinMachineMemory = 15, // Мало доступной памяти
                MaxMachineMemory = 30,
                PsoSwarmSize = 35,
                PsoMaxIterations = 200,
                PsoInertiaWeight = 0.7,
                PsoCognitiveWeight = 1.8,
                PsoSocialWeight = 1.8,
                PsoNoImprovementLimit = 30,
                GaPopulationSize = 40,
                GaMaxGenerations = 200,
                GaCrossoverRate = 0.8,
                GaMutationRate = 0.15, // Высокая мутация для исследования
                GaEliteRatio = 0.1,
                GaTournamentSize = 4,
                GaNoImprovementLimit = 30
            },
            
            // Эксперимент 6: Высокая производительность
            new ExperimentPreset
            {
                Id = 6,
                Name = "Эксперимент 6: Высокая производительность",
                TaskCount = 120,
                MachineCount = 12,
                RandomSeed = 67890,
                MinComputationVolume = 30,
                MaxComputationVolume = 180,
                MinMemoryRequirement = 10,
                MaxMemoryRequirement = 40,
                MaxPredecessors = 4,
                MinMachinePerformance = 40, // Высокая производительность
                MaxMachinePerformance = 100,
                MinMachineMemory = 40,
                MaxMachineMemory = 100,
                PsoSwarmSize = 60,
                PsoMaxIterations = 350,
                PsoInertiaWeight = 0.75,
                PsoCognitiveWeight = 1.9,
                PsoSocialWeight = 1.9,
                PsoNoImprovementLimit = 45,
                GaPopulationSize = 100,
                GaMaxGenerations = 350,
                GaCrossoverRate = 0.85,
                GaMutationRate = 0.06,
                GaEliteRatio = 0.12,
                GaTournamentSize = 6,
                GaNoImprovementLimit = 45
            },
            
            // Эксперимент 7: Много машин
            new ExperimentPreset
            {
                Id = 7,
                Name = "Эксперимент 7: Много машин",
                TaskCount = 80,
                MachineCount = 15,
                RandomSeed = 78901,
                MinComputationVolume = 20,
                MaxComputationVolume = 100,
                MinMemoryRequirement = 5,
                MaxMemoryRequirement = 25,
                MaxPredecessors = 3,
                MinMachinePerformance = 10,
                MaxMachinePerformance = 30,
                MinMachineMemory = 20,
                MaxMachineMemory = 40,
                PsoSwarmSize = 45,
                PsoMaxIterations = 250,
                PsoInertiaWeight = 0.85,
                PsoCognitiveWeight = 1.4,
                PsoSocialWeight = 1.4,
                PsoNoImprovementLimit = 35,
                GaPopulationSize = 70,
                GaMaxGenerations = 250,
                GaCrossoverRate = 0.9,
                GaMutationRate = 0.07,
                GaEliteRatio = 0.1,
                GaTournamentSize = 5,
                GaNoImprovementLimit = 35
            },
            
            // Эксперимент 8: Несбалансированные ресурсы
            new ExperimentPreset
            {
                Id = 8,
                Name = "Эксперимент 8: Несбалансированные ресурсы",
                TaskCount = 70,
                MachineCount = 7,
                RandomSeed = 89012,
                MinComputationVolume = 25,
                MaxComputationVolume = 130,
                MinMemoryRequirement = 6,
                MaxMemoryRequirement = 35,
                MaxPredecessors = 4,
                MinMachinePerformance = 5, // Большой разброс в производительности
                MaxMachinePerformance = 60,
                MinMachineMemory = 15, // Большой разброс в памяти
                MaxMachineMemory = 70,
                PsoSwarmSize = 50,
                PsoMaxIterations = 300,
                PsoInertiaWeight = 0.6,
                PsoCognitiveWeight = 2.2,
                PsoSocialWeight = 2.2,
                PsoNoImprovementLimit = 40,
                GaPopulationSize = 90,
                GaMaxGenerations = 300,
                GaCrossoverRate = 0.88,
                GaMutationRate = 0.09,
                GaEliteRatio = 0.15,
                GaTournamentSize = 7,
                GaNoImprovementLimit = 40
            },
            
            // Эксперимент 9: Большие задачи, мало машин
            new ExperimentPreset
            {
                Id = 9,
                Name = "Эксперимент 9: Большие задачи, мало машин",
                TaskCount = 90,
                MachineCount = 5,
                RandomSeed = 90123,
                MinComputationVolume = 40,
                MaxComputationVolume = 200,
                MinMemoryRequirement = 15,
                MaxMemoryRequirement = 50,
                MaxPredecessors = 3,
                MinMachinePerformance = 20,
                MaxMachinePerformance = 60,
                MinMachineMemory = 50,
                MaxMachineMemory = 120,
                PsoSwarmSize = 55,
                PsoMaxIterations = 350,
                PsoInertiaWeight = 0.5,
                PsoCognitiveWeight = 2.5,
                PsoSocialWeight = 2.5,
                PsoNoImprovementLimit = 45,
                GaPopulationSize = 110,
                GaMaxGenerations = 350,
                GaCrossoverRate = 0.92,
                GaMutationRate = 0.04,
                GaEliteRatio = 0.18,
                GaTournamentSize = 8,
                GaNoImprovementLimit = 45
            },
            
            // Эксперимент 10: Смешанный сложный случай
            new ExperimentPreset
            {
                Id = 10,
                Name = "Эксперимент 10: Смешанный сложный случай",
                TaskCount = 150,
                MachineCount = 15,
                RandomSeed = 123456,
                MinComputationVolume = 50,
                MaxComputationVolume = 250,
                MinMemoryRequirement = 20,
                MaxMemoryRequirement = 60,
                MaxPredecessors = 6,
                MinMachinePerformance = 30,
                MaxMachinePerformance = 120,
                MinMachineMemory = 40,
                MaxMachineMemory = 150,
                PsoSwarmSize = 80,
                PsoMaxIterations = 500,
                PsoInertiaWeight = 0.55,
                PsoCognitiveWeight = 2.8,
                PsoSocialWeight = 2.8,
                PsoNoImprovementLimit = 60,
                GaPopulationSize = 150,
                GaMaxGenerations = 500,
                GaCrossoverRate = 0.95,
                GaMutationRate = 0.03,
                GaEliteRatio = 0.2,
                GaTournamentSize = 10,
                GaNoImprovementLimit = 60
            }
        };
        
        _selectedExperiment = _experimentPresets.FirstOrDefault();
    }
    
    private async void HandleStatusChanged(object? sender, AlgorithmStatus status)
    {
        await InvokeAsync(StateHasChanged);
    }
    
    private void BuildOptions()
    {
        var options = new ChartOptions
        {
            ChartPalette = _colors,
            EnableSmoothGradient = _enableSmoothGradient,
            YAxisLines = true,
            XAxisLines = true,
        };
        _heatmapOptions = options;
    }
    
    private void BuildHeatmapData()
    {
        if (AlgorithmService.VisualizationData?.ResourceHeatmap == null)
            return;
            
        var heatmapData = AlgorithmService.VisualizationData.ResourceHeatmap;
        
        // Создаем метки оси X - идентификаторы машин
        _xLabels = heatmapData.MachineIds.Select(id => $"VM {id}").ToArray();
        
        // Создаем метки оси Y - различные показатели утилизации
        _yLabels = ["Утилизация CPU", "Утилизация памяти", "Нагрузка по задачам", "Общая эффективность"];
        
        // Инициализируем генератор случайных чисел для демонстрационных данных
        var random = new Random();
        
        // Создаем серии для тепловой карты (двумерный массив)
        _heatmapSeries = new List<ChartSeries>();
        
        // Для каждой метрики (строки) создаем свой ряд данных
        for (int row = 0; row < _yLabels.Length; row++)
        {
            var rowData = new double[_xLabels.Length];
            
            for (int col = 0; col < _xLabels.Length; col++)
            {
                // Берем базовую утилизацию из исходных данных
                double baseUtilization = heatmapData.UtilizationValues[col];
                
                // В зависимости от строки (метрики) генерируем разные значения
                // Для демонстрации создаем реалистичные данные на основе базовой утилизации
                switch (row)
                {
                    case 0: // Утилизация CPU
                        rowData[col] = Math.Round(baseUtilization * 100, 1);
                        break;
                    case 1: // Утилизация памяти
                        // Память обычно утилизируется немного по-другому
                        double memoryUtil = baseUtilization * (0.7 + random.NextDouble() * 0.6);
                        rowData[col] = Math.Round(Math.Min(memoryUtil, 1.0) * 100, 1);
                        break;
                    case 2: // Нагрузка по задачам
                        // Предположим, что каждая задача занимает 5-15% ресурсов
                        int taskCount = (int)(baseUtilization * 100 / (10 + random.NextDouble() * 10));
                        rowData[col] = Math.Round(taskCount * 10.0, 1); // Преобразуем в проценты
                        break;
                    case 3: // Общая эффективность
                        // Комбинированная метрика
                        double efficiency = (baseUtilization + (random.NextDouble() * 0.3 - 0.15)) * 100;
                        rowData[col] = Math.Round(Math.Max(0, Math.Min(efficiency, 100)), 1);
                        break;
                }
            }
            
            _heatmapSeries.Add(new ChartSeries 
            { 
                Name = _yLabels[row], 
                Data = rowData
            });
        }
        
        BuildOptions();
    }
    
    private async System.Threading.Tasks.Task InitializeProblem()
    {
        try
        {
            if (!_config.Validate())
            {
                Snackbar.Add("Ошибка валидации параметров генерации", Severity.Error);
                return;
            }

            AlgorithmService.CurrentAlgorithmType = _selectedAlgorithmType;
            
            AlgorithmService.InitializeRandomInstance(
                _config.TaskCount,
                _config.MachineCount,
                _config.RandomSeed,
                new TaskGenerationConfig
                {
                    MinComputationVolume = _config.MinComputationVolume,
                    MaxComputationVolume = _config.MaxComputationVolume,
                    MinMemoryRequirement = _config.MinMemoryRequirement,
                    MaxMemoryRequirement = _config.MaxMemoryRequirement,
                    MaxPredecessors = _config.MaxPredecessors,
                    MinMachinePerformance = _config.MinMachinePerformance,
                    MaxMachinePerformance = _config.MaxMachinePerformance,
                    MinMachineMemory = _config.MinMachineMemory,
                    MaxMachineMemory = _config.MaxMachineMemory
                });
            
            Snackbar.Add($"Задача создана: {_config.TaskCount} задач, {_config.MachineCount} машин", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка инициализации: {ex.Message}", Severity.Error);
        }
    }
    
    private async System.Threading.Tasks.Task StartAlgorithm()
    {
        try
        {
            _isRunning = true;
            
            // Устанавливаем конфигурацию алгоритма
            UpdateAlgorithmConfiguration();

            if (_stepMode)
            {
                await AlgorithmService.StartStepModeAsync();
                Snackbar.Add("Пошаговый режим активирован", Severity.Info);
            }
            else
            {
                await AlgorithmService.RunAlgorithmAsync();
                Snackbar.Add("Алгоритм успешно завершен", Severity.Success);
                
                // Сохраняем результат в историю экспериментов
                if (AlgorithmService.CurrentSolution != null)
                {
                    SaveExperimentResult();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка выполнения: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRunning = false;
            StateHasChanged();
        }
    }

    private void UpdateAlgorithmConfiguration()
    {
        if (_selectedAlgorithmType == AlgorithmType.Pso)
        {
            AlgorithmService.PsoConfig = _psoConfig;
        }
        else
        {
            AlgorithmService.GaConfig = _gaConfig;
        }
    }

    private async System.Threading.Tasks.Task StepAlgorithm()
    {
        try
        {
            if (!_stepMode)
            {
                return;
            }

            if (AlgorithmService.Status != AlgorithmStatus.Running && AlgorithmService.Status != AlgorithmStatus.Ready && AlgorithmService.Status != AlgorithmStatus.Completed)
            {
                return;
            }

            await AlgorithmService.StepAsync();

            if (AlgorithmService.Status == AlgorithmStatus.Completed)
            {
                Snackbar.Add("Алгоритм завершен в пошаговом режиме", Severity.Success);
                
                // Сохраняем результат в историю экспериментов
                if (AlgorithmService.CurrentSolution != null)
                {
                    SaveExperimentResult();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка пошагового выполнения: {ex.Message}", Severity.Error);
        }
        finally
        {
            StateHasChanged();
        }
    }
    
    private void StopAlgorithm()
    {
        AlgorithmService.StopAlgorithm();
        Snackbar.Add("Алгоритм остановлен", Severity.Warning);
    }
    
    private void ResetAlgorithm()
    {
        AlgorithmService.Reset();
        _isRunning = false;
        _heatmapSeries.Clear();
        _xLabels = [];
        _yLabels = [];
        
        Snackbar.Add("Состояние сброшено", Severity.Info);
    }
    
    private void HandleProgressChanged(object? sender, AlgorithmProgress progress)
    {
        if (progress.IsComplete)
        {
            _isRunning = false;
        }
        
        InvokeAsync(StateHasChanged);
    }
    
    private void HandleSolutionFound(object? sender, Solution solution)
    {
        BuildHeatmapData();
        InvokeAsync(StateHasChanged);
    }
    
    private void HandleVisualizationUpdated(object? sender, VisualizationData data)
    {
        BuildHeatmapData();
        InvokeAsync(StateHasChanged);
    }
    
    // Методы для работы с экспериментами
    
    private string GetExperimentName(ExperimentPreset preset)
    {
        return preset?.Name ?? "Неизвестный эксперимент";
    }
    
    private async System.Threading.Tasks.Task LoadExperimentPreset()
    {
        if (_selectedExperiment == null)
            return;
            
        try
        {
            // Загружаем параметры задачи
            _config.TaskCount = _selectedExperiment.TaskCount;
            _config.MachineCount = _selectedExperiment.MachineCount;
            _config.RandomSeed = _selectedExperiment.RandomSeed;
            _config.MinComputationVolume = _selectedExperiment.MinComputationVolume;
            _config.MaxComputationVolume = _selectedExperiment.MaxComputationVolume;
            _config.MinMemoryRequirement = _selectedExperiment.MinMemoryRequirement;
            _config.MaxMemoryRequirement = _selectedExperiment.MaxMemoryRequirement;
            _config.MaxPredecessors = _selectedExperiment.MaxPredecessors;
            _config.MinMachinePerformance = _selectedExperiment.MinMachinePerformance;
            _config.MaxMachinePerformance = _selectedExperiment.MaxMachinePerformance;
            _config.MinMachineMemory = _selectedExperiment.MinMachineMemory;
            _config.MaxMachineMemory = _selectedExperiment.MaxMachineMemory;
            
            // Загружаем параметры PSO
            _psoConfig.SwarmSize = _selectedExperiment.PsoSwarmSize;
            _psoConfig.MaxIterations = _selectedExperiment.PsoMaxIterations;
            _psoConfig.InertiaWeight = _selectedExperiment.PsoInertiaWeight;
            _psoConfig.CognitiveWeight = _selectedExperiment.PsoCognitiveWeight;
            _psoConfig.SocialWeight = _selectedExperiment.PsoSocialWeight;
            _psoConfig.NoImprovementLimit = _selectedExperiment.PsoNoImprovementLimit;
            
            // Загружаем параметры GA
            _gaConfig.PopulationSize = _selectedExperiment.GaPopulationSize;
            _gaConfig.MaxGenerations = _selectedExperiment.GaMaxGenerations;
            _gaConfig.CrossoverRate = _selectedExperiment.GaCrossoverRate;
            _gaConfig.MutationRate = _selectedExperiment.GaMutationRate;
            _gaConfig.EliteRatio = _selectedExperiment.GaEliteRatio;
            _gaConfig.TournamentSize = _selectedExperiment.GaTournamentSize;
            _gaConfig.NoImprovementLimit = _selectedExperiment.GaNoImprovementLimit;
            
            // Устанавливаем алгоритм PSO как основной
            _selectedAlgorithmType = AlgorithmType.Pso;
            AlgorithmService.CurrentAlgorithmType = AlgorithmType.Pso;
            
            Snackbar.Add($"Параметры эксперимента '{_selectedExperiment.Name}' загружены", Severity.Success);
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка загрузки эксперимента: {ex.Message}", Severity.Error);
        }
    }
    
    private async System.Threading.Tasks.Task RunExperimentSeries()
    {
        if (_experimentPresets.Count == 0)
            return;
            
        try
        {
            Snackbar.Add("Начало серии экспериментов...", Severity.Info);
            
            foreach (var preset in _experimentPresets)
            {
                // Запускаем эксперимент с PSO (2 раза)
                for (int run = 1; run <= 2; run++)
                {
                    Snackbar.Add($"Эксперимент {preset.Id} (PSO), запуск {run}...", Severity.Info);
                    
                    // Загружаем параметры
                    _selectedExperiment = preset;
                    await LoadExperimentPreset();
                    
                    // Инициализируем задачу
                    await InitializeProblem();
                    
                    // Запускаем алгоритм
                    _isRunning = true;
                    UpdateAlgorithmConfiguration();
                    
                    try
                    {
                        await AlgorithmService.RunAlgorithmAsync();
                        
                        if (AlgorithmService.CurrentSolution != null)
                        {
                            SaveExperimentResult();
                        }
                    }
                    catch (Exception ex)
                    {
                        Snackbar.Add($"Ошибка в эксперименте {preset.Id}: {ex.Message}", Severity.Error);
                    }
                    
                    // Небольшая пауза между запусками
                    await System.Threading.Tasks.Task.Delay(500);
                }
                
                // Если включено сравнение с GA, запускаем GA
                if (_includeGaComparison)
                {
                    Snackbar.Add($"Эксперимент {preset.Id} (GA)...", Severity.Info);
                    
                    // Устанавливаем алгоритм GA
                    _selectedAlgorithmType = AlgorithmType.Genetic;
                    AlgorithmService.CurrentAlgorithmType = AlgorithmType.Genetic;
                    
                    // Инициализируем задачу с теми же параметрами
                    await InitializeProblem();
                    
                    // Запускаем алгоритм
                    _isRunning = true;
                    UpdateAlgorithmConfiguration();
                    
                    try
                    {
                        await AlgorithmService.RunAlgorithmAsync();
                        
                        if (AlgorithmService.CurrentSolution != null)
                        {
                            SaveExperimentResult();
                        }
                    }
                    catch (Exception ex)
                    {
                        Snackbar.Add($"Ошибка в эксперименте {preset.Id} (GA): {ex.Message}", Severity.Error);
                    }
                    
                    // Возвращаем PSO как основной алгоритм
                    _selectedAlgorithmType = AlgorithmType.Pso;
                    AlgorithmService.CurrentAlgorithmType = AlgorithmType.Pso;
                }
                
                // Пауза между экспериментами
                await System.Threading.Tasks.Task.Delay(1000);
            }
            
            Snackbar.Add("Серия экспериментов завершена!", Severity.Success);
            
            // Экспортируем историю экспериментов
            await ExportExperimentHistory();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка выполнения серии экспериментов: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRunning = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private void SaveExperimentResult()
    {
        if (AlgorithmService.CurrentSolution == null || AlgorithmService.CurrentInstance == null)
            return;
            
        var result = new ExperimentResult
        {
            ExperimentNumber = _experimentCounter++,
            AlgorithmType = _selectedAlgorithmType.ToString(),
            Timestamp = DateTime.Now,
            TaskCount = AlgorithmService.CurrentInstance.Tasks.Count,
            MachineCount = AlgorithmService.CurrentInstance.VirtualMachines.Count,
            Makespan = AlgorithmService.CurrentSolution.Makespan,
            TotalPenalty = AlgorithmService.CurrentSolution.TotalPenalty,
            Fitness = AlgorithmService.CurrentSolution.Fitness,
            ComputationTime = AlgorithmService.CurrentSolution.ComputationTime,
            IterationFound = AlgorithmService.CurrentSolution.IterationFound,
            IsFeasible = AlgorithmService.CurrentSolution.TotalPenalty <= 0,
            Configuration = _selectedExperiment != null ? _selectedExperiment.Name : "Пользовательская конфигурация"
        };
        
        _experimentHistory.Add(result);
        
        Snackbar.Add($"Результат эксперимента {result.ExperimentNumber} сохранен", Severity.Info);
    }
    
    private async System.Threading.Tasks.Task LoadExperimentResult(ExperimentResult result)
    {
        // Здесь можно добавить функционал для загрузки сохраненного результата
        Snackbar.Add($"Загрузка результата эксперимента {result.ExperimentNumber}", Severity.Info);
    }
    
    // Методы экспорта
    
    private async System.Threading.Tasks.Task ExportResults()
    {
        if (AlgorithmService.CurrentSolution == null || AlgorithmService.CurrentInstance == null)
        {
            Snackbar.Add("Нет данных для экспорта", Severity.Warning);
            return;
        }
        
        try
        {
            var exportData = new
            {
                Metadata = new
                {
                    ExportDate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"),
                    Algorithm = _selectedAlgorithmType.ToString(),
                    TaskCount = AlgorithmService.CurrentInstance.Tasks.Count,
                    MachineCount = AlgorithmService.CurrentInstance.VirtualMachines.Count
                },
                Configuration = new
                {
                    TaskConfiguration = _config,
                    AlgorithmConfiguration = _selectedAlgorithmType == AlgorithmType.Pso ? 
                        (object)_psoConfig : _gaConfig
                },
                Solution = new
                {
                    Makespan = AlgorithmService.CurrentSolution.Makespan,
                    TotalPenalty = AlgorithmService.CurrentSolution.TotalPenalty,
                    Fitness = AlgorithmService.CurrentSolution.Fitness,
                    ComputationTime = AlgorithmService.CurrentSolution.ComputationTime.TotalSeconds,
                    IterationFound = AlgorithmService.CurrentSolution.IterationFound,
                    Assignment = AlgorithmService.CurrentSolution.Assignment,
                    IsValid = AlgorithmService.CurrentSolution.IsValid(AlgorithmService.CurrentInstance)
                },
                Analysis = ResultAnalyzer.Analyze(AlgorithmService.CurrentSolution, AlgorithmService.CurrentInstance)
            };
            
            string json = System.Text.Json.JsonSerializer.Serialize(exportData, 
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            
            string fileName = $"optimization_result_{DateTime.Now:yyyyMMdd_HHmmss}.json";
            await DownloadFile(fileName, "application/json", json);
            
            Snackbar.Add($"Результаты экспортированы в {fileName}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка экспорта: {ex.Message}", Severity.Error);
        }
    }
    
    private async System.Threading.Tasks.Task ExportExperimentHistory()
    {
        if (_experimentHistory.Count == 0)
        {
            Snackbar.Add("Нет истории экспериментов для экспорта", Severity.Warning);
            return;
        }
        
        try
        {
            var exportData = new
            {
                Metadata = new
                {
                    ExportDate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"),
                    ExperimentCount = _experimentHistory.Count,
                    Description = "Результаты 10 экспериментов с PSO (каждый запущен 2 раза) и сравнение с GA"
                },
                Experiments = _experimentHistory,
                Summary = new
                {
                    AverageMakespan = _experimentHistory.Average(e => e.Makespan),
                    AverageComputationTime = _experimentHistory.Average(e => e.ComputationTime.TotalSeconds),
                    PsoResults = _experimentHistory.Where(e => e.AlgorithmType == "Pso").ToList(),
                    GaResults = _experimentHistory.Where(e => e.AlgorithmType == "Genetic").ToList(),
                    BestPSOResult = _experimentHistory.Where(e => e.AlgorithmType == "Pso").OrderBy(e => e.Fitness).FirstOrDefault(),
                    BestGAResult = _experimentHistory.Where(e => e.AlgorithmType == "Genetic").OrderBy(e => e.Fitness).FirstOrDefault()
                }
            };
            
            string json = System.Text.Json.JsonSerializer.Serialize(exportData, 
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            
            string fileName = $"experiment_history_{DateTime.Now:yyyyMMdd_HHmmss}.json";
            await DownloadFile(fileName, "application/json", json);
            
            Snackbar.Add($"История экспериментов экспортирована в {fileName}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка экспорта истории: {ex.Message}", Severity.Error);
        }
    }
    
    private async System.Threading.Tasks.Task DownloadFile(string fileName, string contentType, string content)
    {
        var bytes = Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);
        
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, contentType, base64);
    }
    
    private Color GetStatusColor(AlgorithmStatus status)
    {
        return status switch
        {
            AlgorithmStatus.Running => Color.Warning,
            AlgorithmStatus.Completed => Color.Success,
            AlgorithmStatus.Error => Color.Error,
            _ => Color.Default
        };
    }
    
    private string GetStatusText(AlgorithmStatus status)
    {
        return status switch
        {
            AlgorithmStatus.Idle => "Ожидание",
            AlgorithmStatus.Ready => "Готов",
            AlgorithmStatus.Running => "Выполняется",
            AlgorithmStatus.Completed => "Завершено",
            AlgorithmStatus.Stopped => "Остановлено",
            AlgorithmStatus.Error => "Ошибка",
            _ => "Неизвестно"
        };
    }
    
    private Color GetPenaltyColor(double penalty)
    {
        return penalty > 0 ? Color.Error : Color.Success;
    }
    
    private Severity GetFeasibilitySeverity(double penalty)
    {
        return penalty > 0 ? Severity.Warning : Severity.Success;
    }
    
    private string GetFeasibilityMessage(double penalty)
    {
        return penalty > 0 
            ? "Решение содержит нарушения ограничений (жесткие ограничения не выполнены)"
            : "Решение допустимо (все ограничения выполнены)";
    }
    
    private Color GetImbalanceColor(double imbalance)
    {
        return imbalance switch
        {
            > 0.3 => Color.Error,
            > 0.15 => Color.Warning,
            _ => Color.Success
        };
    }
    
    public void Dispose()
    {
        AlgorithmService.OnProgressChanged -= HandleProgressChanged;
        AlgorithmService.OnSolutionFound -= HandleSolutionFound;
        AlgorithmService.OnVisualizationDataUpdated -= HandleVisualizationUpdated;
        AlgorithmService.OnStatusChanged -= HandleStatusChanged;
    }
    
    // Вспомогательные классы
    
    private class ProblemConfiguration
    {
        public int TaskCount { get; set; } = 20;
        public int MachineCount { get; set; } = 4;
        public int? RandomSeed { get; set; }
        
        // Параметры генерации задач
        public int MinComputationVolume { get; set; }
        public int MaxComputationVolume { get; set; }
        public int MinMemoryRequirement { get; set; }
        public int MaxMemoryRequirement { get; set; }
        public int MaxPredecessors { get; set; }
        
        // Параметры генерации машин
        public int MinMachinePerformance { get; set; }
        public int MaxMachinePerformance { get; set; }
        public int MinMachineMemory { get; set; }
        public int MaxMachineMemory { get; set; }
        
        public bool Validate()
        {
            if (MinComputationVolume > MaxComputationVolume) return false;
            if (MinMemoryRequirement > MaxMemoryRequirement) return false;
            if (MinMachinePerformance > MaxMachinePerformance) return false;
            if (MinMachineMemory > MaxMachineMemory) return false;
            if (MaxPredecessors < 0) return false;
            
            return true;
        }
    }
    
    private class ExperimentPreset
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        
        // Параметры задачи
        public int TaskCount { get; set; }
        public int MachineCount { get; set; }
        public int RandomSeed { get; set; }
        public int MinComputationVolume { get; set; }
        public int MaxComputationVolume { get; set; }
        public int MinMemoryRequirement { get; set; }
        public int MaxMemoryRequirement { get; set; }
        public int MaxPredecessors { get; set; }
        public int MinMachinePerformance { get; set; }
        public int MaxMachinePerformance { get; set; }
        public int MinMachineMemory { get; set; }
        public int MaxMachineMemory { get; set; }
        
        // Параметры PSO
        public int PsoSwarmSize { get; set; }
        public int PsoMaxIterations { get; set; }
        public double PsoInertiaWeight { get; set; }
        public double PsoCognitiveWeight { get; set; }
        public double PsoSocialWeight { get; set; }
        public int PsoNoImprovementLimit { get; set; }
        
        // Параметры GA
        public int GaPopulationSize { get; set; }
        public int GaMaxGenerations { get; set; }
        public double GaCrossoverRate { get; set; }
        public double GaMutationRate { get; set; }
        public double GaEliteRatio { get; set; }
        public int GaTournamentSize { get; set; }
        public int GaNoImprovementLimit { get; set; }
    }
    
    private class ExperimentResult
    {
        public int ExperimentNumber { get; set; }
        public string AlgorithmType { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public int TaskCount { get; set; }
        public int MachineCount { get; set; }
        public double Makespan { get; set; }
        public double TotalPenalty { get; set; }
        public double Fitness { get; set; }
        public TimeSpan ComputationTime { get; set; }
        public int IterationFound { get; set; }
        public bool IsFeasible { get; set; }
        public string Configuration { get; set; } = string.Empty;
    }
}