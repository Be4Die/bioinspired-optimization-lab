@page "/"
@using Lab.Web.Services
@using Lab.PSO
@using Size = MudBlazor.Size
@using MudBlazor
@inject PsoService PsoService
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>PSO Algorithm - Распределение задач в облачной среде</PageTitle>

<!-- Основная структура 1/3 слева, 2/3 справа -->
<MudGrid>
    <!-- Левая колонка (1/3) -->
    <MudItem xs="12" md="4" class="pl-md-4 pr-md-2">
        <!-- Панель управления -->
        <MudPaper Class="pa-3 mb-3" Elevation="1">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Панель управления</MudText>
                </MudItem>
                
                <!-- Конфигурация задачи -->
                <MudItem xs="12" sm="6" md="6">
                    <MudNumericField T="int" @bind-Value="_config.TaskCount"
                                     Label="Количество задач"
                                     Min="1"
                                     Max="100"
                                     Immediate="true"
                                     Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6" md="6">
                    <MudNumericField T="int" @bind-Value="_config.MachineCount"
                                     Label="Количество машин"
                                     Min="1"
                                     Max="20"
                                     Immediate="true"
                                     Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12">
                    <MudNumericField T="int?" @bind-Value="_config.RandomSeed"
                                     Label="Семя генератора"
                                     HelperText="Оставьте пустым для случайного"
                                     Margin="Margin.Dense" />
                </MudItem>
                
                <!-- Дополнительные параметры генерации -->
                <MudItem xs="12" Class="mt-3">
                    <MudExpansionPanel Text="Дополнительные параметры генерации" Icon="@Icons.Material.Filled.Tune">
                        <MudGrid>
                            <!-- Параметры задач -->
                            <MudItem xs="12">
                                <MudText Typo="Typo.subtitle2" Class="mb-2 mt-2">Параметры задач</MudText>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. объем вычислений: @_config.MinComputationVolume</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinComputationVolume"
                                          ValueChanged="@(v => _config.MinComputationVolume = v)"
                                          Min="1" 
                                          Max="50" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. объем вычислений: @_config.MaxComputationVolume</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxComputationVolume"
                                          ValueChanged="@(v => _config.MaxComputationVolume = v)"
                                          Min="50" 
                                          Max="200" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. требование памяти: @_config.MinMemoryRequirement</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinMemoryRequirement"
                                          ValueChanged="@(v => _config.MinMemoryRequirement = v)"
                                          Min="1" 
                                          Max="10" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. требование памяти: @_config.MaxMemoryRequirement</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxMemoryRequirement"
                                          ValueChanged="@(v => _config.MaxMemoryRequirement = v)"
                                          Min="10" 
                                          Max="50" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. предшественников: @_config.MaxPredecessors</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxPredecessors"
                                          ValueChanged="@(v => _config.MaxPredecessors = v)"
                                          Min="0" 
                                          Max="5" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <!-- Параметры машин -->
                            <MudItem xs="12" Class="mt-3">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Параметры машин</MudText>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. производительность: @_config.MinMachinePerformance</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinMachinePerformance"
                                          ValueChanged="@(v => _config.MinMachinePerformance = v)"
                                          Min="1" 
                                          Max="20" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. производительность: @_config.MaxMachinePerformance</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxMachinePerformance"
                                          ValueChanged="@(v => _config.MaxMachinePerformance = v)"
                                          Min="20" 
                                          Max="100" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Мин. память машины: @_config.MinMachineMemory</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MinMachineMemory"
                                          ValueChanged="@(v => _config.MinMachineMemory = v)"
                                          Min="5" 
                                          Max="20" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">Макс. память машины: @_config.MaxMachineMemory</MudText>
                                <MudSlider T="int" 
                                          Value="@_config.MaxMachineMemory"
                                          ValueChanged="@(v => _config.MaxMachineMemory = v)"
                                          Min="20" 
                                          Max="100" 
                                          Immediate="true"
                                          ValueLabel="true"
                                          Class="mt-1" />
                            </MudItem>
                            
                            <!-- Валидация -->
                            <MudItem xs="12" Class="mt-3">
                                @if (!_config.Validate())
                                {
                                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
                                        Ошибка валидации: Минимальные значения должны быть меньше максимальных
                                    </MudAlert>
                                }
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudItem>
                
                <!-- Конфигурация алгоритма PSO -->
                <MudItem xs="12" Class="mt-3">
                    <MudText Typo="Typo.h6" Class="mb-2">Настройки алгоритма PSO</MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="6">
                    <MudNumericField T="int" @bind-Value="_psoConfig.SwarmSize"
                                     Label="Размер роя"
                                     Min="10"
                                     Max="200"
                                     Immediate="true"
                                     Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6" md="6">
                    <MudNumericField T="int" @bind-Value="_psoConfig.MaxIterations"
                                     Label="Макс. итераций"
                                     Min="10"
                                     Max="1000"
                                     Immediate="true"
                                     Margin="Margin.Dense" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.body2">Инерция (w): @_psoConfig.InertiaWeight.ToString("F1")</MudText>
                    <MudSlider T="double" 
                              Value="@_psoConfig.InertiaWeight"
                              ValueChanged="@(v => _psoConfig.InertiaWeight = v)"
                              Min="0.1" 
                              Max="1.5" 
                              Step="0.1"
                              Immediate="true"
                              ValueLabel="true"
                              Class="mt-1" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.body2">Когнитивный (c1): @_psoConfig.CognitiveWeight.ToString("F1")</MudText>
                    <MudSlider T="double" 
                              Value="@_psoConfig.CognitiveWeight"
                              ValueChanged="@(v => _psoConfig.CognitiveWeight = v)"
                              Min="0.1" 
                              Max="3.0" 
                              Step="0.1"
                              Immediate="true"
                              ValueLabel="true"
                              Class="mt-1" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.body2">Социальный (c2): @_psoConfig.SocialWeight.ToString("F1")</MudText>
                    <MudSlider T="double" 
                              Value="@_psoConfig.SocialWeight"
                              ValueChanged="@(v => _psoConfig.SocialWeight = v)"
                              Min="0.1" 
                              Max="3.0" 
                              Step="0.1"
                              Immediate="true"
                              ValueLabel="true"
                              Class="mt-1" />
                </MudItem>
                
                <MudItem xs="12" Class="mt-2">
                    <MudNumericField T="int" @bind-Value="_psoConfig.NoImprovementLimit"
                                     Label="Лимит без улучшений"
                                     Min="5"
                                     Max="200"
                                     HelperText="Остановка после N итераций без улучшений"
                                     Immediate="true"
                                     Margin="Margin.Dense" />
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Кнопки управления -->
        <MudPaper Class="pa-3 mb-3" Elevation="1">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Управление выполнением</MudText>
                </MudItem>
                
                <!-- Статус -->
                <MudItem xs="12" Class="mb-2">
                    <div class="d-flex justify-center">
                        <MudChip T="string" Variant="Variant.Filled" 
                                 Color="GetStatusColor(PsoService.Status)"
                                 Class="ma-1">
                            @GetStatusText(PsoService.Status)
                        </MudChip>
                    </div>
                </MudItem>

                <!-- Кнопка инициализации -->
                <MudItem xs="12" Class="mb-2">
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.PlayArrow"
                              OnClick="@InitializeProblem"
                              FullWidth="true"
                              Disabled="@(PsoService.Status == AlgorithmStatus.Running || !_config.Validate())"
                              Size="Size.Small">
                        Инициализировать задачу
                    </MudButton>
                </MudItem>
                
                <!-- Пошаговый режим -->
                <MudItem xs="12" Class="mb-2">
                    <MudCheckBox T="bool"
                                 @bind-Value="_stepMode"
                                 Disabled="@(PsoService.Status == AlgorithmStatus.Running)"
                                 Label="Пошаговый режим"
                                 Size="Size.Small" />
                </MudItem>
                
                <!-- Кнопки управления -->
                <MudItem xs="12" Class="mt-2">
                    <div class="d-flex flex-column gap-2">
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Success"
                                  StartIcon="@Icons.Material.Filled.PlayCircle"
                                  OnClick="@StartAlgorithm"
                                  Disabled="@(PsoService.Status != AlgorithmStatus.Ready && PsoService.Status != AlgorithmStatus.Completed || !_config.Validate())"
                                  Loading="@_isRunning"
                                  Size="Size.Small">
                            @(_isRunning ? "Выполняется..." : "Запустить алгоритм")
                        </MudButton>

                        @if (_stepMode)
                        {
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.SkipNext"
                                      OnClick="@StepAlgorithm"
                                      Disabled="!PsoService.CanStep"
                                      Size="Size.Small">
                                Шаг
                            </MudButton>
                        }
                        
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Error"
                                  StartIcon="@Icons.Material.Filled.Stop"
                                  OnClick="@StopAlgorithm"
                                  Disabled="@(PsoService.Status != AlgorithmStatus.Running)"
                                  Size="Size.Small">
                            Остановить
                        </MudButton>
                        
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Secondary"
                                  StartIcon="@Icons.Material.Filled.Refresh"
                                  OnClick="@ResetAlgorithm"
                                  Size="Size.Small">
                            Сброс
                        </MudButton>
                    </div>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Информация о задаче -->
        @if (PsoService.CurrentInstance != null)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Информация о задаче</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E3F2FD;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Задач</MudText>
                            <MudText Typo="Typo.h5">@PsoService.CurrentInstance.Tasks.Count</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E8F5E9;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Машин</MudText>
                            <MudText Typo="Typo.h5">@PsoService.CurrentInstance.VirtualMachines.Count</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #FFF3E0;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Зависимостей</MudText>
                            <MudText Typo="Typo.h5">
                                @PsoService.CurrentInstance.Tasks.Values.Sum(t => t.PredecessorIds.Count)
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #F3E5F5;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Общая память</MudText>
                            <MudText Typo="Typo.h5">
                                @PsoService.CurrentInstance.VirtualMachines.Values.Sum(m => m.AvailableMemory)
                            </MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        <!-- Результаты -->
        @if (PsoService.CurrentSolution != null)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Результаты решения</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E8F5E9;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Makespan</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">
                                @PsoService.CurrentSolution.Makespan.ToString("F2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #FFF3E0;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Штраф</MudText>
                            <MudText Typo="Typo.h5" Color="@GetPenaltyColor(PsoService.CurrentSolution.TotalPenalty)">
                                @PsoService.CurrentSolution.TotalPenalty.ToString("F2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #E3F2FD;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Фитнес</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Primary">
                                @PsoService.CurrentSolution.Fitness.ToString("F2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="6">
                        <MudPaper Class="pa-2 text-center" Elevation="0" Style="background-color: #F3E5F5;">
                            <MudText Typo="Typo.caption" Color="Color.Default">Время вычисления</MudText>
                            <MudText Typo="Typo.h5">
                                @PsoService.CurrentSolution.ComputationTime.TotalSeconds.ToString("F2") с
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" Class="mt-2">
                        <MudAlert Severity="GetFeasibilitySeverity(PsoService.CurrentSolution.TotalPenalty)"
                                  Variant="Variant.Filled"
                                  Dense="true"
                                  Size="Size.Small">
                            @GetFeasibilityMessage(PsoService.CurrentSolution.TotalPenalty)
                        </MudAlert>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
    </MudItem>

    <!-- Правая колонка (2/3) -->
    <MudItem xs="12" md="8" class="pr-md-4 pl-md-2">
        <!-- Управление видимостью -->
        <MudPaper Class="pa-3 mb-3" Elevation="1">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Управление визуализацией</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSwitch @bind-Value="_showGraph"
                               Color="Color.Primary"
                               Label="Показать граф назначений"
                               Disabled="@(PsoService.CurrentInstance == null)"
                               Size="Size.Small" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSwitch @bind-Value="_showHeatmap"
                               Color="Color.Primary"
                               Label="Показать тепловую карту"
                               Disabled="@(PsoService.CurrentSolution == null)"
                               Size="Size.Small" />
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Граф назначений -->
        @if (_showGraph && PsoService.CurrentInstance != null)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <BipartiteGraphView Instance="PsoService.CurrentInstance" 
                                   Solution="PsoService.CurrentSolution" />
            </MudPaper>
        }

        <!-- Тепловая карта -->
        @if (_showHeatmap && PsoService.VisualizationData != null && PsoService.VisualizationData.ResourceHeatmap?.MachineIds?.Count > 0)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Тепловая карта утилизации ресурсов</MudText>
                        <MudText Typo="Typo.body2" Class="mb-2">
                            Визуализация использования вычислительных ресурсов виртуальных машин
                        </MudText>
                    </MudItem>
                    
                    <!-- Статистика -->
                    <MudItem xs="12" Class="mb-2">
                        @{
                            var heatmapData = PsoService.VisualizationData.ResourceHeatmap;
                            var minUtil = heatmapData.UtilizationValues.Min();
                            var maxUtil = heatmapData.UtilizationValues.Max();
                            var avgUtil = heatmapData.UtilizationValues.Average();
                            var variance = heatmapData.UtilizationValues.Sum(v => Math.Pow(v - avgUtil, 2)) / heatmapData.UtilizationValues.Count;
                            var imbalance = Math.Sqrt(variance);
                        }
                        <MudGrid>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Минимум</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success">
                                        @(minUtil.ToString("P0"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Среднее</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Primary">
                                        @(avgUtil.ToString("P0"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Максимум</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Error">
                                        @(maxUtil.ToString("P0"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-2 text-center" Elevation="1">
                                    <MudText Typo="Typo.caption" Color="Color.Default">Неравномерность</MudText>
                                    <MudText Typo="Typo.h6" Color="@GetImbalanceColor(imbalance)">
                                        @(imbalance.ToString("P1"))
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </MudItem>

                    <!-- Тепловая карта MudBlazor -->
                    <MudItem xs="12" Class="mt-3">
                        <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background-color: #fafafa;">
                            <MudChart ChartType="ChartType.HeatMap" 
                                     ChartSeries="@_heatmapSeries" 
                                     ChartOptions="@_heatmapOptions"
                                     XAxisLabels="@_xLabels" 
                                     YAxisLabels="@_yLabels"
                                     Width="100%" 
                                     Height="400px"
                                     Style="--mud-palette-heatmap-cell-min-width: 72px; --mud-palette-heatmap-cell-font-size: 0.76rem; --mud-palette-heatmap-cell-font-weight: 500;"
                                     TooltipEnabled="true"></MudChart>
                            
                            <!-- Панель управления градиентом -->
                            <div class="mt-3" style="display: flex; align-items: center; justify-content: space-between; padding: 0 10px;">
                                <div style="display: flex; align-items: center;">
                                    <MudCheckBox T="bool" @bind-Value="_enableSmoothGradient" 
                                               @bind-Value:after="BuildOptions" 
                                               Color="Color.Primary"
                                               Label="Плавный градиент"
                                               Size="Size.Small">
                                    </MudCheckBox>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 10px; flex: 1; justify-content: center;">
                                    <MudText Typo="Typo.caption" Color="Color.Default" Style="min-width: 30px;">0%</MudText>
                                    <div style="flex: 1; max-width: 400px; height: 20px; border-radius: 4px; background: linear-gradient(to right, #5AC8FA, #34C759, #007AFF);"></div>
                                    <MudText Typo="Typo.caption" Color="Color.Default" Style="min-width: 40px;">100%</MudText>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Palette" Size="Size.Small" Color="Color.Primary" />
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        Градиент: @(_enableSmoothGradient ? "Плавный" : "Дискретный")
                                    </MudText>
                                </div>
                            </div>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else if (_showHeatmap)
        {
            <MudPaper Class="pa-3 mb-3" Elevation="1">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Тепловая карта утилизации ресурсов</MudText>
                        <MudText Typo="Typo.body2" Class="mb-2">
                            Визуализация использования вычислительных ресурсов виртуальных машин
                        </MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <div style="text-align: center; padding: 30px; border: 2px dashed #e0e0e0; border-radius: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.ShowChart" Size="Size.Large" Color="Color.Default" Class="mb-2" />
                            <MudText Typo="Typo.body1" Color="Color.Default" Class="d-block mb-2">
                                Нет данных для отображения тепловой карты
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Default" Class="d-block">
                                Запустите алгоритм для получения результатов распределения задач
                            </MudText>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
    </MudItem>
</MudGrid>

@code {
    // Конфигурация
    private ProblemConfiguration _config = new() { 
        TaskCount = 20, 
        MachineCount = 4,
        MinComputationVolume = 10,
        MaxComputationVolume = 100,
        MinMemoryRequirement = 1,
        MaxMemoryRequirement = 20,
        MaxPredecessors = 3,
        MinMachinePerformance = 5,
        MaxMachinePerformance = 25,
        MinMachineMemory = 10,
        MaxMachineMemory = 30
    };
    private PsoConfiguration _psoConfig = PsoConfiguration.Default;
    
    // Состояние UI
    private bool _isRunning = false;
    private bool _stepMode = false;
    private bool _showGraph = true;
    private bool _showHeatmap = true;
    
    // Данные для тепловой карты
    private bool _enableSmoothGradient = true;
    private readonly string[] _colors = ["#5AC8FA", "#34C759", "#007AFF"];
    private List<ChartSeries> _heatmapSeries = [];
    private ChartOptions _heatmapOptions = new();
    private string[] _xLabels = []; // Метки по оси X (машины)
    private string[] _yLabels = []; // Метки по оси Y (метрики)
    
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        BuildOptions();
        
        // Подписываемся на события сервиса
        PsoService.OnProgressChanged += HandleProgressChanged;
        PsoService.OnSolutionFound += HandleSolutionFound;
        PsoService.OnVisualizationDataUpdated += HandleVisualizationUpdated;
    }
    
    private void BuildOptions()
    {
        var options = new ChartOptions
        {
            ChartPalette = _colors,
            EnableSmoothGradient = _enableSmoothGradient,
            YAxisLines = true,
            XAxisLines = true,
        };
        _heatmapOptions = options;
    }
    
    private void BuildHeatmapData()
    {
        if (PsoService.VisualizationData?.ResourceHeatmap == null)
            return;
            
        var heatmapData = PsoService.VisualizationData.ResourceHeatmap;
        
        // Создаем метки оси X - идентификаторы машин
        _xLabels = heatmapData.MachineIds.Select(id => $"VM {id}").ToArray();
        
        // Создаем метки оси Y - различные показатели утилизации
        _yLabels = ["Утилизация CPU", "Утилизация памяти", "Нагрузка по задачам", "Общая эффективность"];
        
        // Инициализируем генератор случайных чисел для демонстрационных данных
        var random = new Random();
        
        // Создаем серии для тепловой карты (двумерный массив)
        _heatmapSeries = new List<ChartSeries>();
        
        // Для каждой метрики (строки) создаем свой ряд данных
        for (int row = 0; row < _yLabels.Length; row++)
        {
            var rowData = new double[_xLabels.Length];
            
            for (int col = 0; col < _xLabels.Length; col++)
            {
                // Берем базовую утилизацию из исходных данных
                double baseUtilization = heatmapData.UtilizationValues[col];
                
                // В зависимости от строки (метрики) генерируем разные значения
                // Для демонстрации создаем реалистичные данные на основе базовой утилизации
                switch (row)
                {
                    case 0: // Утилизация CPU
                        rowData[col] = Math.Round(baseUtilization * 100, 1);
                        break;
                    case 1: // Утилизация памяти
                        // Память обычно утилизируется немного по-другому
                        double memoryUtil = baseUtilization * (0.7 + random.NextDouble() * 0.6);
                        rowData[col] = Math.Round(Math.Min(memoryUtil, 1.0) * 100, 1);
                        break;
                    case 2: // Нагрузка по задачам
                        // Предположим, что каждая задача занимает 5-15% ресурсов
                        int taskCount = (int)(baseUtilization * 100 / (10 + random.NextDouble() * 10));
                        rowData[col] = Math.Round(taskCount * 10.0, 1); // Преобразуем в проценты
                        break;
                    case 3: // Общая эффективность
                        // Комбинированная метрика
                        double efficiency = (baseUtilization + (random.NextDouble() * 0.3 - 0.15)) * 100;
                        rowData[col] = Math.Round(Math.Max(0, Math.Min(efficiency, 100)), 1);
                        break;
                }
            }
            
            _heatmapSeries.Add(new ChartSeries 
            { 
                Name = _yLabels[row], 
                Data = rowData
            });
        }
        
        BuildOptions();
    }
    
    private async System.Threading.Tasks.Task InitializeProblem()
    {
        try
        {
            if (!_config.Validate())
            {
                Snackbar.Add("Ошибка валидации параметров генерации", Severity.Error);
                return;
            }

            PsoService.InitializeRandomInstance(
                _config.TaskCount,
                _config.MachineCount,
                _config.RandomSeed,
                new TaskGenerationConfig
                {
                    MinComputationVolume = _config.MinComputationVolume,
                    MaxComputationVolume = _config.MaxComputationVolume,
                    MinMemoryRequirement = _config.MinMemoryRequirement,
                    MaxMemoryRequirement = _config.MaxMemoryRequirement,
                    MaxPredecessors = _config.MaxPredecessors,
                    MinMachinePerformance = _config.MinMachinePerformance,
                    MaxMachinePerformance = _config.MaxMachinePerformance,
                    MinMachineMemory = _config.MinMachineMemory,
                    MaxMachineMemory = _config.MaxMachineMemory
                });
            
            Snackbar.Add($"Задача создана: {_config.TaskCount} задач, {_config.MachineCount} машин", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка инициализации: {ex.Message}", Severity.Error);
        }
    }
    
    private async System.Threading.Tasks.Task StartAlgorithm()
    {
        try
        {
            _isRunning = true;

            if (_stepMode)
            {
                await PsoService.StartStepModeAsync(_psoConfig);
                Snackbar.Add("Пошаговый режим активирован", Severity.Info);
            }
            else
            {
                await PsoService.RunAlgorithmAsync(_psoConfig);
                Snackbar.Add("Алгоритм успешно завершен", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка выполнения: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRunning = false;
            StateHasChanged();
        }
    }

    private async System.Threading.Tasks.Task StepAlgorithm()
    {
        try
        {
            if (!_stepMode)
            {
                return;
            }

            if (PsoService.Status != AlgorithmStatus.Running && PsoService.Status != AlgorithmStatus.Ready && PsoService.Status != AlgorithmStatus.Completed)
            {
                return;
            }

            await PsoService.StepAsync();

            if (PsoService.Status == AlgorithmStatus.Completed)
            {
                Snackbar.Add("Алгоритм завершен в пошаговом режиме", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка пошагового выполнения: {ex.Message}", Severity.Error);
        }
        finally
        {
            StateHasChanged();
        }
    }
    
    private void StopAlgorithm()
    {
        PsoService.StopAlgorithm();
        Snackbar.Add("Алгоритм остановлен", Severity.Warning);
    }
    
    private void ResetAlgorithm()
    {
        PsoService.Reset();
        _isRunning = false;
        _heatmapSeries.Clear();
        _xLabels = [];
        _yLabels = [];
        
        Snackbar.Add("Состояние сброшено", Severity.Info);
    }
    
    private void HandleProgressChanged(object? sender, AlgorithmProgress progress)
    {
        if (progress.IsComplete)
        {
            _isRunning = false;
        }
        
        InvokeAsync(StateHasChanged);
    }
    
    private void HandleSolutionFound(object? sender, Solution solution)
    {
        BuildHeatmapData();
        InvokeAsync(StateHasChanged);
    }
    
    private void HandleVisualizationUpdated(object? sender, VisualizationData data)
    {
        BuildHeatmapData();
        InvokeAsync(StateHasChanged);
    }
    
    private Color GetStatusColor(AlgorithmStatus status)
    {
        return status switch
        {
            AlgorithmStatus.Running => Color.Warning,
            AlgorithmStatus.Completed => Color.Success,
            AlgorithmStatus.Error => Color.Error,
            _ => Color.Default
        };
    }
    
    private string GetStatusText(AlgorithmStatus status)
    {
        return status switch
        {
            AlgorithmStatus.Idle => "Ожидание",
            AlgorithmStatus.Ready => "Готов",
            AlgorithmStatus.Running => "Выполняется",
            AlgorithmStatus.Completed => "Завершено",
            AlgorithmStatus.Stopped => "Остановлено",
            AlgorithmStatus.Error => "Ошибка",
            _ => "Неизвестно"
        };
    }
    
    private Color GetPenaltyColor(double penalty)
    {
        return penalty > 0 ? Color.Error : Color.Success;
    }
    
    private Severity GetFeasibilitySeverity(double penalty)
    {
        return penalty > 0 ? Severity.Warning : Severity.Success;
    }
    
    private string GetFeasibilityMessage(double penalty)
    {
        return penalty > 0 
            ? "Решение содержит нарушения ограничений (жесткие ограничения не выполнены)"
            : "Решение допустимо (все ограничения выполнены)";
    }
    
    private Color GetImbalanceColor(double imbalance)
    {
        return imbalance switch
        {
            > 0.3 => Color.Error,
            > 0.15 => Color.Warning,
            _ => Color.Success
        };
    }
    
    public void Dispose()
    {
        PsoService.OnProgressChanged -= HandleProgressChanged;
        PsoService.OnSolutionFound -= HandleSolutionFound;
        PsoService.OnVisualizationDataUpdated -= HandleVisualizationUpdated;
    }
    
    // Вспомогательные классы
    private class ProblemConfiguration
    {
        public int TaskCount { get; set; } = 20;
        public int MachineCount { get; set; } = 4;
        public int? RandomSeed { get; set; }
        
        // Параметры генерации задач
        public int MinComputationVolume { get; set; }
        public int MaxComputationVolume { get; set; }
        public int MinMemoryRequirement { get; set; }
        public int MaxMemoryRequirement { get; set; }
        public int MaxPredecessors { get; set; }
        
        // Параметры генерации машин
        public int MinMachinePerformance { get; set; }
        public int MaxMachinePerformance { get; set; }
        public int MinMachineMemory { get; set; }
        public int MaxMachineMemory { get; set; }
        
        public bool Validate()
        {
            if (MinComputationVolume > MaxComputationVolume) return false;
            if (MinMemoryRequirement > MaxMemoryRequirement) return false;
            if (MinMachinePerformance > MaxMachinePerformance) return false;
            if (MinMachineMemory > MaxMachineMemory) return false;
            if (MaxPredecessors < 0) return false;
            
            return true;
        }
    }
}